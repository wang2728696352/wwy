<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<title>–ü–∏–≤–Ω–æ–π –°–æ–∫–æ–±–∞–Ω - –ü–∏–≤–Ω–∞—è –∏–≥—Ä–∞ –°–æ–∫–æ–±–∞–Ω</title>

<script>
// ËÆæÂ§áÊ£ÄÊµãÂáΩÊï∞
function detectDeviceAndRedirect() {
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const urlParams = new URLSearchParams(window.location.search);
  const forceDesktop = urlParams.get('desktop');
  const forceMobile = urlParams.get('mobile');
  
  if (forceDesktop) {
    localStorage.setItem('preferDesktop', 'true');
    localStorage.removeItem('preferMobile');
  } else if (forceMobile) {
    localStorage.setItem('preferMobile', 'true');
    localStorage.removeItem('preferDesktop');
  }
  
  const preferDesktop = localStorage.getItem('preferDesktop') === 'true';
  const preferMobile = localStorage.getItem('preferMobile') === 'true';
  
  if ((isMobile && !preferDesktop) || preferMobile) {
    applyMobileStyles();
  } else {
    applyDesktopStyles();
  }
}

// Â∫îÁî®ÁßªÂä®Á´ØÊ†∑Âºè
function applyMobileStyles() {
  document.body.classList.add('mobile-device');
  document.body.classList.remove('desktop-device');
  
  const mobileCSS = `
    .mobile-device #gameCanvas {
      max-width: 100% !important;
      max-height: 65vh !important;
      width: auto !important;
      height: auto !important;
    }
    
    .mobile-device #mobile-controls {
      display: flex !important;
    }
    
    .mobile-device #hud {
      font-size: 14px;
      left: 5px;
      top: 5px;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      border-radius: 6px;
      max-width: 120px;
    }
    
    .mobile-device #hud button {
      padding: 6px 8px;
      font-size: 11px;
      min-height: 32px;
      margin: 2px;
    }
    
    .mobile-device #music-control {
      right: 5px;
      top: 5px;
      background: rgba(0,0,0,0.7);
      padding: 5px;
      border-radius: 6px;
    }
    
    .mobile-device .control-btn {
      width: 65px !important;
      height: 65px !important;
      font-size: 24px !important;
      margin: 6px !important;
      background: rgba(0,0,0,0.7) !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      border-radius: 50% !important;
      display: flex !important;
    }
    
    .mobile-device .screen {
      padding: 5px;
    }
    
    .mobile-device h1 {
      font-size: 32px !important;
      text-align: center;
    }
    
    .mobile-device button {
      min-height: 44px;
      font-size: 16px;
    }
    
    .mobile-device .level-btn {
      width: 110px;
      height: 75px;
      font-size: 14px;
    }
    
    .mobile-device .info {
      font-size: 12px;
      text-align: center;
      padding: 0 10px;
    }
    
    @media (max-width: 480px) {
      .mobile-device h1 { font-size: 28px !important; }
      .mobile-device .control-btn { 
        width: 55px !important; 
        height: 55px !important; 
        font-size: 20px !important; 
      }
      .mobile-device #hud {
        font-size: 12px;
        max-width: 110px;
      }
    }
  `;
  
  const style = document.createElement('style');
  style.id = 'mobile-styles';
  style.textContent = mobileCSS;
  
  // ÁßªÈô§ÊóßÁöÑÁßªÂä®Ê†∑Âºè
  const oldStyle = document.getElementById('mobile-styles');
  if (oldStyle) {
    oldStyle.remove();
  }
  document.head.appendChild(style);
  
  // ÊòæÁ§∫ÁßªÂä®ÊéßÂà∂ÊåâÈíÆ
  document.getElementById('mobile-controls').style.display = 'flex';
  const controlButtons = document.querySelectorAll('.control-btn');
  controlButtons.forEach(btn => {
    btn.style.display = 'flex';
  });
  
  if (!document.getElementById('version-notice')) {
    const notice = document.createElement('div');
    notice.id = 'version-notice';
    notice.innerHTML = `
      <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
                 background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; 
                 border-radius: 20px; font-size: 12px; z-index: 1000;">
        üì± ÊâãÊú∫Áâà | <a href="?desktop=true" style="color: #f5c542;">ÂàáÊç¢Âà∞ÁîµËÑëÁâà</a>
      </div>
    `;
    document.body.appendChild(notice);
  }
}

// Â∫îÁî®Ê°åÈù¢Á´ØÊ†∑Âºè
function applyDesktopStyles() {
  document.body.classList.add('desktop-device');
  document.body.classList.remove('mobile-device');
  
  // ÁßªÈô§ÁßªÂä®Á´ØÊ†∑Âºè
  const mobileStyles = document.getElementById('mobile-styles');
  if (mobileStyles) {
    mobileStyles.remove();
  }
  
  // ÈöêËóèÁßªÂä®ÊéßÂà∂ÊåâÈíÆ
  document.getElementById('mobile-controls').style.display = 'none';
  const controlButtons = document.querySelectorAll('.control-btn');
  controlButtons.forEach(btn => {
    btn.style.display = 'none';
  });
  
  if (!document.getElementById('version-notice')) {
    const notice = document.createElement('div');
    notice.id = 'version-notice';
    notice.innerHTML = `
      <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
                 background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; 
                 border-radius: 20px; font-size: 12px; z-index: 1000;">
        üñ•Ô∏è ÁîµËÑëÁâà | <a href="?mobile=true" style="color: #f5c542;">ÂàáÊç¢Âà∞ÊâãÊú∫Áâà</a>
      </div>
    `;
    document.body.appendChild(notice);
  }
}
</script>

<style>
  :root { --bg:#0f1113; --panel:#111; --accent:#f5c542; }
  html,body{
    height:100%;
    margin:0;
    padding:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:#fff;
    text-size-adjust:100%;
    -webkit-text-size-adjust:100%;
    overflow: hidden;
    touch-action: manipulation;
  }
  
  .screen{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    -webkit-user-select:none;
    user-select:none;
    padding: 20px;
    box-sizing: border-box;
  }
  
  button{
    cursor:pointer;
    border:none;
    border-radius:8px;
    padding:12px 20px;
    margin:6px;
    background:#333;
    color:#fff;
    font-size:18px;
    -webkit-user-select:none;
    user-select:none;
    min-height: 44px;
  }
  
  h1{margin:8px; text-align:center;}
  
  #main-menu{display:flex}
  
  #level-select .levels{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    justify-content:center;
    max-width: 920px;
    padding: 10px;
  }
  
  .level-btn{
    width: 160px;
    height: 80px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#222;
    border-radius:8px;
    font-size:16px;
  }
  
  #game-container{
    display:flex;
    background:#000;
    align-items:center;
    justify-content:center;
    width: 100%;
    height: 100%;
    position: relative;
  }
  
  #gameCanvas {
    width: 680px;
    height: 680px;
  }
  
  #hud{
    position:absolute;
    left:18px;
    top:18px;
    z-index:30;
    display:flex;
    flex-direction:column;
    gap:8px;
    background: rgba(0,0,0,0.5);
    padding: 10px;
    border-radius: 8px;
  }
  
  #hud button{
    padding:6px 10px;
    font-size:14px;
  }
  
  #mobile-controls{
    position: fixed;
    bottom: 20px;
    left: 0;
    right: 0;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 40;
    touch-action: manipulation;
  }
  
  .control-row{
    display: flex;
    justify-content: center;
    margin: 5px 0;
  }
  
  .control-btn{
    width: 70px;
    height: 70px;
    margin: 8px;
    font-size: 28px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
    cursor: pointer;
  }
  
  #winBox{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    background:rgba(255,255,255,0.96);
    color:#222;
    padding:20px 26px;
    border-radius:10px;
    display:none;
    z-index:60;
    text-align:center;
    -webkit-user-select:none;
    user-select:none;
    max-width: 400px;
    width: 90%;
    box-sizing: border-box;
  }
  
  #winBox button{
    margin:6px;
    width: 100%;
    max-width: 200px;
  }
  
  #loadingOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
    color:#fff
  }
  
  .info {
    opacity:0.85;
    font-size:13px;
    text-align: center;
    padding: 0 10px;
    margin: 5px 0;
  }
  
  #music-control{
    position:absolute;
    right:18px;
    top:18px;
    z-index:30;
  }
  
  #music-control button{
    background:rgba(0,0,0,0.7);
    color:#fff;
    font-size: 14px;
    padding: 8px 12px;
  }
</style>
</head>
<body>

<!-- ‰∏ªËèúÂçï -->
<div id="main-menu" class="screen">
  <h1 style="font-size:56px">üç∫ –ü–∏–≤–Ω–æ–π –°–æ–∫–æ–±–∞–Ω</h1>
  <div style="display:flex;flex-direction:column;align-items:center">
    <div style="margin-bottom:14px">
      <button id="startGameBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <button id="levelSelectBtn">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</button>
      <button onclick="openSettings()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
    <div class="info">–¶–µ–ª—å: –¢–æ–ª–∫–∞–π—Ç–µ –æ—Ç–∫—Ä—ã–≤–∞—à–∫–∏ (—è—â–∏–∫–∏) –Ω–∞ –ø–∏–≤–æ ‚Üí –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–∏—Ç—å—è ‚Üí –í—ã–ø–µ–π—Ç–µ –≤—Å—ë –ø–∏–≤–æ, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —É—Ä–æ–≤–µ–Ω—å</div>
    <div class="info">–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–æ–ª–∫–∞—Ç—å –ø—É—Å—Ç—ã–µ –±—É—Ç—ã–ª–∫–∏!</div>
  </div>
</div>

<!-- ÂÖ≥Âç°ÈÄâÊã© -->
<div id="level-select" class="screen">
  <h1 style="font-size:44px">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</h1>
  <div class="levels" id="levelsContainer" style="margin:18px"></div>
  <div style="margin-top:16px">
    <button onclick="returnToMenu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
  </div>
</div>

<!-- Ê∏∏ÊàèÁïåÈù¢ -->
<div id="game-container" class="screen">
  <div style="position:relative">
    <canvas id="gameCanvas" width="680" height="680"></canvas>
    <div id="hud" style="">
      <div>–£—Ä–æ–≤–µ–Ω—å <span id="currentLevelLabel">1</span></div>
      <div>–®–∞–≥–∏: <span id="moveCount">0</span></div>
      <div><button onclick="restartLevel()">–°–±—Ä–æ—Å</button><button onclick="openLevelSelect()">–í—ã–π—Ç–∏</button></div>
    </div>
    <div id="music-control">
      <button id="toggleMusic">üîä –ú—É–∑—ã–∫–∞</button>
    </div>
    
    <!-- ÁßªÂä®ÊéßÂà∂ÊåâÈíÆ -->
    <div id="mobile-controls">
      <div class="control-row">
        <button class="control-btn" id="btn-up">‚Üë</button>
      </div>
      <div class="control-row">
        <button class="control-btn" id="btn-left">‚Üê</button>
        <button class="control-btn" id="btn-down">‚Üì</button>
        <button class="control-btn" id="btn-right">‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- ËÉúÂà©ÊèêÁ§∫ -->
<div id="winBox">
  <div id="winText" style="font-size:18px;margin-bottom:10px">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</div>
  <div>
    <button id="btnNext">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
    <button id="btnReplay">–ü–µ—Ä–µ–∏–≥—Ä–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
    <button onclick="openLevelSelect()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —É—Ä–æ–≤–Ω—è</button>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay"><div style="text-align:center"><h2>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤‚Ä¶</h2></div></div>

<script>
// Ê∑ªÂä†ÁßªÂä®ÊéßÂà∂ÂäüËÉΩ - ‰øÆÂ§çÁâàÊú¨
function setupMobileControls() {
  const controlButtons = document.querySelectorAll('.control-btn');
  
  // ÊòæÁ§∫ÊéßÂà∂ÊåâÈíÆ
  document.getElementById('mobile-controls').style.display = 'flex';
  controlButtons.forEach(btn => {
    btn.style.display = 'flex';
  });
  
  // Èò≤Ê≠¢ÈáçÂ§çËß¶ÂèëÁöÑÊ†áÂøó
  let isProcessing = false;
  
  // ‰∏∫ÊâÄÊúâÊéßÂà∂ÊåâÈíÆÊ∑ªÂä†Ëß¶Êë∏ÂíåÈº†Ê†á‰∫ã‰ª∂
  function addControlEvent(buttonId, dx, dy) {
    const button = document.getElementById(buttonId);
    
    // Ëß¶Êë∏‰∫ã‰ª∂
    button.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (!isProcessing) {
        isProcessing = true;
        movePlayer(dx, dy);
        setTimeout(() => { isProcessing = false; }, 200);
      }
    }, { passive: false });
    
    // Èº†Ê†á‰∫ã‰ª∂ - ‰øÆÂ§çÁîµËÑëÁâàÁÇπÂáªÈóÆÈ¢ò
    button.addEventListener('mousedown', (e) => {
      e.preventDefault();
      if (!isProcessing) {
        isProcessing = true;
        movePlayer(dx, dy);
        setTimeout(() => { isProcessing = false; }, 200);
      }
    });
    
    button.addEventListener('click', (e) => {
      e.preventDefault();
    });
  }
  
  addControlEvent('btn-up', 0, -1);
  addControlEvent('btn-down', 0, 1);
  addControlEvent('btn-left', -1, 0);
  addControlEvent('btn-right', 1, 0);
  
  // Èò≤Ê≠¢ÊåâÈíÆÈïøÊåâÂá∫Áé∞ÊñáÊú¨ÈÄâÊã©
  controlButtons.forEach(btn => {
    btn.addEventListener('contextmenu', (e) => e.preventDefault());
  });
}

// Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
         window.innerWidth <= 768;
}

/* =========================
   ÈÖçÁΩÆ‰∏éËµÑÊ∫ê - ‰øÆÂ§çÁâàÊú¨
   ========================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 60;
const COLS = 12, ROWS = 12;

// ËµÑÊ∫êÂàóË°®
const imagesToLoad = {
  bg: "./images/bg_room.png",
  floor: "./images/floor.png",
  wall: "./images/wall.png",
  player: "./images/player.png",
  box: "./images/opener.png",
  beer: "./images/beer.png",
  drink: "./images/drink.gif",
  emptyBeer: "./images/empty_beer.png"
};

// Èü≥È¢ëËµÑÊ∫ê - ‰ΩøÁî®Êõ¥ÂÖºÂÆπÁöÑÊñπÂºè
const audioToLoad = {
  bgMusic: "./audio/background-music.mp3",
  drinkSound: "./audio/drink-sound.mp3"
};

let imgs = {};
let audio = {};
let loaded = 0, totalImgs = Object.keys(imagesToLoad).length;
let audioLoaded = 0, totalAudio = Object.keys(audioToLoad).length;
let resourcesReady = false;

// Èü≥È¢ëÁä∂ÊÄÅ
let musicEnabled = true;
let audioInitialized = false;

// ÊîπËøõÁöÑËµÑÊ∫êÂä†ËΩΩÂáΩÊï∞ - Ëß£ÂÜ≥ÊâãÊú∫Âä†ËΩΩÈóÆÈ¢ò
function preload() {
  document.getElementById('loadingOverlay').style.display = 'flex';
  console.log("ÂºÄÂßãÈ¢ÑÂä†ËΩΩËµÑÊ∫ê...");
  
  // ËÆæÁΩÆÂä†ËΩΩË∂ÖÊó∂Ôºà15ÁßíÔºâ
  const loadTimeout = setTimeout(() => {
    if (!resourcesReady) {
      console.warn("ËµÑÊ∫êÂä†ËΩΩË∂ÖÊó∂ÔºåÂº∫Âà∂ÁªßÁª≠");
      forceContinue();
    }
  }, 15000);
  
  // È¢ÑÂä†ËΩΩÂõæÁâá
  for (const k in imagesToLoad) {
    const img = new Image();
    img.src = imagesToLoad[k];
    img.onload = () => {
      loaded++;
      console.log(`‚úÖ ÂõæÁâáÂä†ËΩΩÊàêÂäü: ${k} (${loaded}/${totalImgs})`);
      imgs[k] = img;
      checkAllResourcesLoaded();
    };
    img.onerror = () => {
      loaded++;
      console.error(`‚ùå ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•: ${imagesToLoad[k]}`);
      // ÂàõÂª∫Âç†‰ΩçÂõæÁâá
      imgs[k] = createPlaceholderImage(k);
      checkAllResourcesLoaded();
    };
  }
  
  // È¢ÑÂä†ËΩΩÈü≥È¢ë - ‰ΩøÁî®Êõ¥ÂÖºÂÆπÁöÑÊñπÊ≥ï
  let audioAttempts = 0;
  const maxAudioAttempts = 3;
  
  function loadAudio() {
    audioAttempts++;
    audioLoaded = 0;
    
    for (const k in audioToLoad) {
      const sound = new Audio();
      sound.preload = "auto";
      
      // ËÆæÁΩÆË∂ÖÊó∂Â§ÑÁêÜ
      const audioTimeout = setTimeout(() => {
        audioLoaded++;
        console.warn(`Èü≥È¢ëÂä†ËΩΩË∂ÖÊó∂: ${k} (Â∞ùËØï ${audioAttempts}/${maxAudioAttempts})`);
        audio[k] = null;
        checkAllResourcesLoaded();
        
        // Â¶ÇÊûúÊâÄÊúâÈü≥È¢ëÈÉΩÂä†ËΩΩË∂ÖÊó∂‰∏îËøòÊúâÂ∞ùËØïÊ¨°Êï∞ÔºåÈáçËØï
        if (audioLoaded === totalAudio && audioAttempts < maxAudioAttempts) {
          console.log("ÈáçÊñ∞Â∞ùËØïÂä†ËΩΩÈü≥È¢ë...");
          setTimeout(loadAudio, 1000);
        }
      }, 5000);
      
      sound.addEventListener('canplaythrough', () => {
        clearTimeout(audioTimeout);
        audioLoaded++;
        console.log(`‚úÖ Èü≥È¢ëÂä†ËΩΩÊàêÂäü: ${k} (${audioLoaded}/${totalAudio})`);
        audio[k] = sound;
        checkAllResourcesLoaded();
      }, { once: true });
      
      sound.addEventListener('error', () => {
        clearTimeout(audioTimeout);
        audioLoaded++;
        console.error(`‚ùå Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•: ${audioToLoad[k]} (Â∞ùËØï ${audioAttempts}/${maxAudioAttempts})`);
        audio[k] = null;
        checkAllResourcesLoaded();
        
        // Â¶ÇÊûúÊâÄÊúâÈü≥È¢ëÈÉΩÂä†ËΩΩÂ§±Ë¥•‰∏îËøòÊúâÂ∞ùËØïÊ¨°Êï∞ÔºåÈáçËØï
        if (audioLoaded === totalAudio && audioAttempts < maxAudioAttempts) {
          console.log("ÈáçÊñ∞Â∞ùËØïÂä†ËΩΩÈü≥È¢ë...");
          setTimeout(loadAudio, 1000);
        }
      }, { once: true });
      
      // ÂºÄÂßãÂä†ËΩΩ
      sound.src = audioToLoad[k];
    }
  }
  
  loadAudio();
  
  function checkAllResourcesLoaded() {
    if (loaded === totalImgs && audioLoaded === totalAudio) {
      clearTimeout(loadTimeout);
      resourcesReady = true;
      document.getElementById('loadingOverlay').style.display = 'none';
      initAudio();
      console.log("üéâ ÊâÄÊúâËµÑÊ∫êÂä†ËΩΩÂÆåÊàêÔºÅ");
    }
  }
  
  function forceContinue() {
    clearTimeout(loadTimeout);
    resourcesReady = true;
    document.getElementById('loadingOverlay').style.display = 'none';
    
    // Á°Æ‰øùÊâÄÊúâÂõæÁâáÈÉΩÊúâÂç†‰ΩçÂõæ
    for (const k in imagesToLoad) {
      if (!imgs[k]) {
        imgs[k] = createPlaceholderImage(k);
      }
    }
    console.log("‚ö†Ô∏è Âº∫Âà∂ÁªßÁª≠Ê∏∏ÊàèÔºàÈÉ®ÂàÜËµÑÊ∫êÂèØËÉΩÁº∫Â§±Ôºâ");
  }
}

// ÂàõÂª∫Âç†‰ΩçÂõæÁâá
function createPlaceholderImage(name) {
  const canvas = document.createElement('canvas');
  canvas.width = 100;
  canvas.height = 100;
  const ctx = canvas.getContext('2d');
  
  const colors = {
    bg: '#1a1a2e', floor: '#2d3047', wall: '#4a4e69',
    player: '#ff6b6b', box: '#f9c74f', beer: '#43aa8b',
    drink: '#277da1', emptyBeer: '#577590'
  };
  
  ctx.fillStyle = colors[name] || '#666';
  ctx.fillRect(0, 0, 100, 100);
  ctx.fillStyle = '#fff';
  ctx.font = '12px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(name, 50, 50);
  
  const img = new Image();
  img.src = canvas.toDataURL();
  return img;
}

// ÂàùÂßãÂåñÈü≥È¢ë
function initAudio() {
  if (audioInitialized) return;
  
  for (const k in audio) {
    if (audio[k]) {
      if (k === 'bgMusic') {
        audio[k].loop = true;
        audio[k].volume = 0.3;
      } else if (k === 'drinkSound') {
        audio[k].volume = 0.7;
      }
    }
  }
  
  audioInitialized = true;
}

// Êí≠ÊîæËÉåÊôØÈü≥‰πê
function playBackgroundMusic() {
  if (!musicEnabled || !audio.bgMusic) return;
  
  // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñáÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
  const playPromise = audio.bgMusic.play();
  
  if (playPromise !== undefined) {
    playPromise.catch(e => {
      console.log("Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•ÔºåÈúÄË¶ÅÁî®Êà∑‰∫§‰∫í:", e);
      // Ê†áËÆ∞ÈúÄË¶ÅÁî®Êà∑‰∫§‰∫í
      window.needsUserInteractionForAudio = true;
    });
  }
}

// Êí≠ÊîæÂñùÂï§ÈÖíÈü≥Êïà
function playDrinkSound() {
  if (!musicEnabled || !audio.drinkSound) return;
  
  // ÂÖãÈöÜÈü≥È¢ëËäÇÁÇπ‰ª•ÈÅøÂÖçÈáçÂè†Êí≠ÊîæÈóÆÈ¢ò
  const sound = audio.drinkSound.cloneNode();
  sound.volume = 0.7;
  
  const playPromise = sound.play();
  
  if (playPromise !== undefined) {
    playPromise.catch(e => {
      console.log("Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:", e);
    });
  }
}

// ÂàáÊç¢Èü≥‰πê
function toggleMusic() {
  musicEnabled = !musicEnabled;
  const button = document.getElementById('toggleMusic');
  
  if (musicEnabled) {
    button.innerHTML = "üîä –ú—É–∑—ã–∫–∞";
    playBackgroundMusic();
  } else {
    button.innerHTML = "üîá –ú—É–∑—ã–∫–∞";
    if (audio.bgMusic) {
      audio.bgMusic.pause();
    }
  }
}

// Áî®Êà∑‰∫§‰∫íÂêéÂàùÂßãÂåñÈü≥È¢ë
function initAudioOnUserInteraction() {
  if (!audioInitialized) {
    initAudio();
  }
  
  // ÈáçÁΩÆÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÁöÑÊ†áÂøó
  window.needsUserInteractionForAudio = false;
  
  playBackgroundMusic();
}

// Ê∑ªÂä†ÂÖ®Â±ÄÁî®Êà∑‰∫§‰∫íÁõëÂê¨Âô®Êù•Ëß£ÈîÅÈü≥È¢ë
document.addEventListener('click', function() {
  if (window.needsUserInteractionForAudio) {
    initAudioOnUserInteraction();
  }
});

document.addEventListener('touchstart', function() {
  if (window.needsUserInteractionForAudio) {
    initAudioOnUserInteraction();
  }
});

/* =========================
   5 ‰∏™ÂÖ≥Âç°
   ========================= */

const LEVELS = [
`############
############
############
#####B######
#####.######
#####O.OB###
###B.OP#####
######O#####
######B#####
############
############
############`,
`############
############
###P..######
###.OO#######
###.O.###B###
#####.###B###
#####....B###
####...#..####
####...########
############
############
############`,
`############
############
############
#####....###
###B.O##.###
##BBO.O..P##
##BB.O.O.###
#######..###
############
############
############
############`,
`############
############
############
#####..#.P##
####...#..##
####O.O.O.##
####.O##..##
####.O.#.###
##BBBBB..###
############
############
############`,
`############
############
############
#####....###
#####OOO.###
###P.OBB.###
###.OBBB####
######..####
############
############
############
############`
].map(s => s.split('\n').map(r => r.split('')));

/* =========================
   ËøêË°åÊó∂Êï∞ÊçÆÁªìÊûÑ‰∏éÁä∂ÊÄÅ
   ========================= */
let map = [];
let playerX = 0, playerY = 0;
let currentLevel = 0;
let drinking = false;
let targetX = null, targetY = null;
let moveCount = 0;
let gameActive = false;

/* =========================
   Â∏ÆÂä©Ôºö‰ªéÂ≠óÁ¨¶Âú∞ÂõæÂä†ËΩΩ map
   ========================= */
function loadLevel(id) {
  currentLevel = id;
  const raw = LEVELS[id-1];
  map = Array.from({length:ROWS}, () => Array(COLS).fill(0));
  targetX = targetY = null;
  moveCount = 0;
  document.getElementById('moveCount').innerText = moveCount;
  document.getElementById('currentLevelLabel').innerText = id;

  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      const ch = raw[y][x];
      if (ch === '#') map[y][x] = 1;
      else if (ch === 'P') { playerX = x; playerY = y; map[y][x] = 0; }
      else if (ch === 'O') map[y][x] = 3;
      else if (ch === 'B') map[y][x] = 4;
      else map[y][x] = 0;
    }
  }
  gameActive = true;
  drinking = false;
  drawFrame();
}

/* =========================
   ÁªòÂà∂ÂáΩÊï∞
   ========================= */
function drawFrame() {
  ctx.fillStyle = '#222';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const bg = imgs.bg;
  if (bg && bg.complete) {
    const scale = Math.max(canvas.width/bg.width, canvas.height/bg.height);
    const w = bg.width * scale, h = bg.height * scale;
    const bx = (canvas.width - w)/2, by = (canvas.height - h)/2;
    ctx.globalAlpha = 0.5;
    ctx.drawImage(bg, bx, by, w, h);
    ctx.globalAlpha = 1;
  }

  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      const px = x * TILE, py = y * TILE;
      if (imgs.floor && imgs.floor.complete) ctx.drawImage(imgs.floor, px, py, TILE, TILE);
      else { ctx.fillStyle='#333'; ctx.fillRect(px,py,TILE,TILE); }

      if (map[y][x] === 4) {
        if (imgs.beer && imgs.beer.complete) ctx.drawImage(imgs.beer, px, py, TILE, TILE);
      }
      if (map[y][x] === 10) {
        if (imgs.emptyBeer && imgs.emptyBeer.complete) ctx.drawImage(imgs.emptyBeer, px, py, TILE, TILE);
      }
      if (map[y][x] === 1) {
        if (imgs.wall && imgs.wall.complete) ctx.drawImage(imgs.wall, px, py, TILE, TILE);
        else { ctx.fillStyle='#666'; ctx.fillRect(px,py,TILE,TILE); }
      }
      if (map[y][x] === 3) {
        if (imgs.box && imgs.box.complete) ctx.drawImage(imgs.box, px, py, TILE, TILE);
      }
    }
  }

  const px = playerX * TILE, py = playerY * TILE;
  if (drinking) {
    if (imgs.drink && imgs.drink.complete) ctx.drawImage(imgs.drink, px, py, TILE, TILE);
  } else {
    if (imgs.player && imgs.player.complete) ctx.drawImage(imgs.player, px, py, TILE, TILE);
  }
}

/* =========================
   ËæÖÂä©ÂáΩÊï∞
   ========================= */
function inBounds(x,y){ return x>=0 && x<COLS && y>=0 && y<ROWS; }
function isWall(x,y) { return !inBounds(x,y) || map[y][x] === 1; }
function isBox(x,y) { return inBounds(x,y) && map[y][x] === 3; }
function isBeer(x,y) { return inBounds(x,y) && map[y][x] === 4; }
function isEmptyBottle(x,y) { return inBounds(x,y) && map[y][x] === 10; }
function isEmpty(x,y) { return inBounds(x,y) && (map[y][x] === 0); }

/* =========================
   ÁßªÂä®ÂáΩÊï∞
   ========================= */
function movePlayer(dx, dy) {
  if (!gameActive || drinking) return;
  
  const nx = playerX + dx, ny = playerY + dy;
  if (isWall(nx,ny)) return;

  if (isBox(nx,ny)) {
    const bx = nx + dx, by = ny + dy;
    if (isWall(bx,by) || isBox(bx,by) || isEmptyBottle(bx,by)) return;
    if (isBeer(bx,by)) {
      map[ny][nx] = 0;
      targetX = bx; targetY = by;
      map[by][bx] = 0;
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      startDrinkAnimation();
    } else if (isEmpty(bx,by)) {
      map[by][bx] = 3;
      map[ny][nx] = 0;
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
      if (checkWin()) showWin();
    }
  } else if (isEmptyBottle(nx,ny)) {
    const bx = nx + dx, by = ny + dy;
    if (isWall(bx,by) || isBox(bx,by)) return;
    
    if (isBeer(bx,by)) {
      map[by][bx] = 10;
      map[ny][nx] = 4;
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    } else if (isEmpty(bx,by)) {
      map[by][bx] = 10;
      map[ny][nx] = 0;
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    }
  } else {
    if (isEmpty(nx,ny) || isBeer(nx,ny)) {
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    }
  }
}

/* =========================
   ÈîÆÁõò‰∫ã‰ª∂
   ========================= */
document.addEventListener('keydown', (e) => {
  if (!gameActive || drinking) return;
  if (e.key === 'ArrowUp') movePlayer(0, -1);
  else if (e.key === 'ArrowDown') movePlayer(0, 1);
  else if (e.key === 'ArrowLeft') movePlayer(-1, 0);
  else if (e.key === 'ArrowRight') movePlayer(1, 0);
});

/* =========================
   ÂñùÈÖíÂä®Áîª
   ========================= */
function startDrinkAnimation(){
  drinking = true;
  playDrinkSound();
  drawFrame();
  setTimeout(() => {
    drinking = false;
    if (targetX !== null && targetY !== null) {
      map[targetY][targetX] = 10;
      targetX = targetY = null;
    }
    drawFrame();
    if (checkWin()) showWin();
  }, 900);
}

/* =========================
   ËÉúÂà©Ê£ÄÊµã
   ========================= */
function checkWin(){
  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      if (map[y][x] === 4) return false;
    }
  }
  return true;
}

/* =========================
   UI ÂáΩÊï∞
   ========================= */
function hideAllScreens(){
  document.getElementById('main-menu').style.display = 'none';
  document.getElementById('level-select').style.display = 'none';
  document.getElementById('game-container').style.display = 'none';
  document.getElementById('winBox').style.display = 'none';
}
function openMainMenu(){ 
  hideAllScreens(); 
  document.getElementById('main-menu').style.display = 'flex'; 
}
function openLevelSelect(){ 
  hideAllScreens(); 
  document.getElementById('level-select').style.display = 'flex'; 
}
function openSettings(){ 
  alert('–ú—É–∑—ã–∫–∞ ' + (musicEnabled ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞') + '. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤ –∏–≥—Ä–æ–≤–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.'); 
}
function returnToMenu(){ 
  gameActive = false; 
  openMainMenu(); 
}
function restartLevel(){ 
  loadLevel(currentLevel); 
  drawFrame(); 
}

/* Â°´ÂÖÖÂÖ≥Âç°ÈÄâÊã©ÊåâÈíÆ */
function buildLevelButtons(){
  const container = document.getElementById('levelsContainer');
  container.innerHTML = '';
  for (let i=0;i<LEVELS.length;i++){
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    btn.innerText = `–£—Ä–æ–≤–µ–Ω—å ${i+1}`;
    btn.onclick = () => { startLevel(i+1); };
    container.appendChild(btn);
  }
}

/* ÂºÄÂßãÈÄâÂÆöÂÖ≥Âç° */
function startLevel(n){
  if (!resourcesReady) {
    document.getElementById('loadingOverlay').style.display = 'flex';
    const t = setInterval(()=>{
      if (resourcesReady) { 
        clearInterval(t); 
        document.getElementById('loadingOverlay').style.display='none'; 
        _startLevel(n); 
      }
    },100);
  } else _startLevel(n);
}
function _startLevel(n){
  hideAllScreens();
  document.getElementById('game-container').style.display = 'flex';
  loadLevel(n);
  
  // ËÆæÁΩÆÁßªÂä®ÊéßÂà∂ÔºàÂ¶ÇÊûúÊòØÁßªÂä®ËÆæÂ§áÊàñÊâãÊú∫ÁâàÔºâ
  if (document.body.classList.contains('mobile-device')) {
    setupMobileControls();
  }
}

/* ËÉúÂà©ÂºπÊ°Ü */
const winBox = document.getElementById('winBox');
const winText = document.getElementById('winText');
const btnNext = document.getElementById('btnNext');
const btnReplay = document.getElementById('btnReplay');

btnNext.addEventListener('click', ()=> {
  if (currentLevel < LEVELS.length) {
    _startLevel(currentLevel+1);
    winBox.style.display = 'none';
  } else {
    openLevelSelect();
    winBox.style.display = 'none';
  }
});
btnReplay.addEventListener('click', ()=> {
  _startLevel(currentLevel);
  winBox.style.display = 'none';
});

function showWin(){
  winText.innerText = `–£—Ä–æ–≤–µ–Ω—å ${currentLevel} –ø—Ä–æ–π–¥–µ–Ω!`;
  btnNext.style.display = (currentLevel < LEVELS.length) ? 'inline-block' : 'none';
  winBox.style.display = 'block';
}

/* È°µÈù¢ÂàùÂßãÂåñ */
window.onload = function() {
  // ÂÖàÊ£ÄÊµãËÆæÂ§áÂπ∂Â∫îÁî®Ê†∑Âºè
  detectDeviceAndRedirect();
  
  // ÂºÄÂßãÈ¢ÑÂä†ËΩΩËµÑÊ∫ê
  preload();
  
  buildLevelButtons();
  openMainMenu();
  
  // Ê∑ªÂä†Èü≥‰πêÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
  document.getElementById('toggleMusic').addEventListener('click', toggleMusic);
  
  // ‰∏∫‰∏ªËèúÂçïÊåâÈíÆÊ∑ªÂä†Èü≥È¢ëÂàùÂßãÂåñ
  document.getElementById('startGameBtn').addEventListener('click', function() {
    initAudioOnUserInteraction();
    openLevelSelect();
  });
  
  document.getElementById('levelSelectBtn').addEventListener('click', function() {
    initAudioOnUserInteraction();
    openLevelSelect();
  });
  
  // draw initial blank canvas
  ctx.fillStyle = '#111';
  ctx.fillRect(0,0,canvas.width,canvas.height);
};

// Èò≤Ê≠¢È°µÈù¢Áº©ÊîæÂíåÊªöÂä®
document.addEventListener('touchmove', function(e) {
  if (e.scale !== 1) {
    e.preventDefault();
  }
}, { passive: false });

// ÂÖÅËÆ∏ÊéßÂà∂ÊåâÈíÆÁöÑËß¶Êë∏ÁßªÂä®
document.body.addEventListener('touchmove', function(e) {
  if (e.target.classList.contains('control-btn')) {
    return;
  }
  e.preventDefault();
}, { passive: false });
</script>
</body>
</html>