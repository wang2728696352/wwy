<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<title>–ü–∏–≤–Ω–æ–π –°–æ–∫–æ–±–∞–Ω - –ü–∏–≤–Ω–∞—è –∏–≥—Ä–∞ –°–æ–∫–æ–±–∞–Ω</title>
<!-- ÂºïÂÖ• Howler.js Èü≥È¢ëÂ∫ì -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
<style>
  :root { --bg:#0f1113; --panel:#111; --accent:#f5c542; }
  html,body{
    height:100%;
    margin:0;
    padding:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:#fff;
    text-size-adjust:100%;
    -webkit-text-size-adjust:100%;
    overflow: hidden;
    touch-action: manipulation;
  }
  
  .screen{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    -webkit-user-select:none;
    user-select:none;
    padding: 20px;
    box-sizing: border-box;
  }
  
  button{
    cursor:pointer;
    border:none;
    border-radius:8px;
    padding:12px 20px;
    margin:6px;
    background:#333;
    color:#fff;
    font-size:18px;
    -webkit-user-select:none;
    user-select:none;
    min-height: 44px;
  }
  
  h1{margin:8px; text-align:center;}
  
  #main-menu{display:flex}
  
  #level-select .levels{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    justify-content:center;
    max-width: 920px;
    padding: 10px;
  }
  
  .level-btn{
    width: 160px;
    height: 80px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#222;
    border-radius:8px;
    font-size:16px;
  }
  
  #game-container{
    display:flex;
    background:#000;
    align-items:center;
    justify-content:center;
    width: 100%;
    height: 100%;
    position: relative;
  }
  
  #gameCanvas {
    width: 680px;
    height: 680px;
  }
  
  #hud{
    position:absolute;
    left:18px;
    top:18px;
    z-index:30;
    display:flex;
    flex-direction:column;
    gap:8px;
    background: rgba(0,0,0,0.5);
    padding: 10px;
    border-radius: 8px;
  }
  
  #hud button{
    padding:6px 10px;
    font-size:14px;
  }
  
  #mobile-controls{
    position: fixed;
    bottom: 20px;
    left: 0;
    right: 0;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 40;
    touch-action: manipulation;
  }
  
  .control-row{
    display: flex;
    justify-content: center;
    margin: 5px 0;
  }
  
  .control-btn{
    width: 70px;
    height: 70px;
    margin: 8px;
    font-size: 28px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
    cursor: pointer;
  }
  
  #winBox{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    background:rgba(255,255,255,0.96);
    color:#222;
    padding:20px 26px;
    border-radius:10px;
    display:none;
    z-index:60;
    text-align:center;
    -webkit-user-select:none;
    user-select:none;
    max-width: 400px;
    width: 90%;
    box-sizing: border-box;
  }
  
  #winBox button{
    margin:6px;
    width: 100%;
    max-width: 200px;
  }
  
  #loadingOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
    color:#fff
  }
  
  .info {
    opacity:0.85;
    font-size:13px;
    text-align: center;
    padding: 0 10px;
    margin: 5px 0;
  }
  
  #music-control{
    position:absolute;
    right:18px;
    top:18px;
    z-index:30;
  }
  
  #music-control button{
    background:rgba(0,0,0,0.7);
    color:#fff;
    font-size: 14px;
    padding: 8px 12px;
  }
  
  /* ÁßªÂä®Á´ØÊ†∑Âºè */
  .mobile-device #gameCanvas {
    max-width: 100% !important;
    max-height: 65vh !important;
    width: auto !important;
    height: auto !important;
  }
  
  .mobile-device #mobile-controls {
    display: flex !important;
  }
  
  .mobile-device #hud {
    font-size: 14px;
    left: 5px;
    top: 5px;
    background: rgba(0,0,0,0.7);
    padding: 8px;
    border-radius: 6px;
    max-width: 120px;
  }
  
  .mobile-device #hud button {
    padding: 6px 8px;
    font-size: 11px;
    min-height: 32px;
    margin: 2px;
  }
  
  .mobile-device #music-control {
    right: 5px;
    top: 5px;
    background: rgba(0,0,0,0.7);
    padding: 5px;
    border-radius: 6px;
  }
  
  .mobile-device .control-btn {
    width: 65px !important;
    height: 65px !important;
    font-size: 24px !important;
    margin: 6px !important;
    background: rgba(0,0,0,0.7) !important;
    border: 2px solid rgba(255,255,255,0.4) !important;
    border-radius: 50% !important;
    display: flex !important;
  }
  
  .mobile-device .screen {
    padding: 5px;
  }
  
  .mobile-device h1 {
    font-size: 32px !important;
    text-align: center;
  }
  
  .mobile-device button {
    min-height: 44px;
    font-size: 16px;
  }
  
  .mobile-device .level-btn {
    width: 110px;
    height: 75px;
    font-size: 14px;
  }
  
  .mobile-device .info {
    font-size: 12px;
    text-align: center;
    padding: 0 10px;
  }
  
  @media (max-width: 480px) {
    .mobile-device h1 { font-size: 28px !important; }
    .mobile-device .control-btn { 
      width: 55px !important; 
      height: 55px !important; 
      font-size: 20px !important; 
    }
    .mobile-device #hud {
      font-size: 12px;
      max-width: 110px;
    }
  }
</style>
</head>
<body>

<!-- ‰∏ªËèúÂçï -->
<div id="main-menu" class="screen">
  <h1 style="font-size:56px">üç∫ –ü–∏–≤–Ω–æ–π –°–æ–∫–æ–±–∞–Ω</h1>
  <div style="display:flex;flex-direction:column;align-items:center">
    <div style="margin-bottom:14px">
      <button id="startGameBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <button id="levelSelectBtn">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</button>
      <button onclick="openSettings()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
    <div class="info">–¶–µ–ª—å: –¢–æ–ª–∫–∞–π—Ç–µ –æ—Ç–∫—Ä—ã–≤–∞—à–∫–∏ (—è—â–∏–∫–∏) –Ω–∞ –ø–∏–≤–æ ‚Üí –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–∏—Ç—å—è ‚Üí –í—ã–ø–µ–π—Ç–µ –≤—Å—ë –ø–∏–≤–æ, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —É—Ä–æ–≤–µ–Ω—å</div>
    <div class="info">–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–æ–ª–∫–∞—Ç—å –ø—É—Å—Ç—ã–µ –±—É—Ç—ã–ª–∫–∏!</div>
  </div>
</div>

<!-- ÂÖ≥Âç°ÈÄâÊã© -->
<div id="level-select" class="screen">
  <h1 style="font-size:44px">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</h1>
  <div class="levels" id="levelsContainer" style="margin:18px"></div>
  <div style="margin-top:16px">
    <button onclick="returnToMenu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
  </div>
</div>

<!-- Ê∏∏ÊàèÁïåÈù¢ -->
<div id="game-container" class="screen">
  <div style="position:relative">
    <canvas id="gameCanvas"></canvas>
    <div id="hud" style="">
      <div>–£—Ä–æ–≤–µ–Ω—å <span id="currentLevelLabel">1</span></div>
      <div>–®–∞–≥–∏: <span id="moveCount">0</span></div>
      <div><button onclick="restartLevel()">–°–±—Ä–æ—Å</button><button onclick="openLevelSelect()">–í—ã–π—Ç–∏</button></div>
    </div>
    <div id="music-control">
      <button id="toggleMusic">üîä –ú—É–∑—ã–∫–∞</button>
    </div>
    
    <!-- ÁßªÂä®ÊéßÂà∂ÊåâÈíÆ -->
    <div id="mobile-controls">
      <div class="control-row">
        <button class="control-btn" id="btn-up">‚Üë</button>
      </div>
      <div class="control-row">
        <button class="control-btn" id="btn-left">‚Üê</button>
        <button class="control-btn" id="btn-down">‚Üì</button>
        <button class="control-btn" id="btn-right">‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- ËÉúÂà©ÊèêÁ§∫ -->
<div id="winBox">
  <div id="winText" style="font-size:18px;margin-bottom:10px">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</div>
  <div>
    <button id="btnNext">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
    <button id="btnReplay">–ü–µ—Ä–µ–∏–≥—Ä–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
    <button onclick="openLevelSelect()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —É—Ä–æ–≤–Ω—è</button>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay"><div style="text-align:center"><h2>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤‚Ä¶</h2></div></div>

<script>
// =========================
// Èü≥È¢ëÁÆ°ÁêÜÂô® - ‰ΩøÁî® Howler.js
// =========================

const AudioManager = {
  sounds: {},
  audioUnlocked: false,
  musicEnabled: true,
  audioLoaded: false,
  
  // ÂàùÂßãÂåñÊâÄÊúâÈü≥È¢ë
  initSounds: function() {
    console.log("ÂàùÂßãÂåñÈü≥È¢ëÁ≥ªÁªü...");
    
    // ËÉåÊôØÈü≥‰πê
    this.sounds.bgMusic = new Howl({
      src: ['./audio/background-music.mp3'],
      loop: true,
      volume: 0.3,
      preload: true,
      onload: () => {
        console.log("ËÉåÊôØÈü≥‰πêÂä†ËΩΩÂÆåÊàê");
        this.checkAllAudioLoaded();
      },
      onloaderror: (id, error) => {
        console.error("ËÉåÊôØÈü≥‰πêÂä†ËΩΩÂ§±Ë¥•:", error);
        this.checkAllAudioLoaded();
      },
      onplayerror: (id, error) => {
        console.log("ËÉåÊôØÈü≥‰πêÊí≠ÊîæÂ§±Ë¥•ÔºåÈúÄË¶ÅÁî®Êà∑‰∫§‰∫í:", error);
        this.audioUnlocked = false;
      }
    });

    // ÂñùÈÖíÈü≥Êïà
    this.sounds.drinkSound = new Howl({
      src: ['./audio/drink-sound.mp3'],
      volume: 0.7,
      preload: true,
      onload: () => {
        console.log("Èü≥ÊïàÂä†ËΩΩÂÆåÊàê");
        this.checkAllAudioLoaded();
      },
      onloaderror: (id, error) => {
        console.error("Èü≥ÊïàÂä†ËΩΩÂ§±Ë¥•:", error);
        this.checkAllAudioLoaded();
      }
    });
    
    // ÂæÆ‰ø°ÁéØÂ¢ÉÁâπÊÆäÂ§ÑÁêÜ
    if (typeof WeixinJSBridge !== 'undefined') {
      console.log("Ê£ÄÊµãÂà∞ÂæÆ‰ø°ÁéØÂ¢ÉÔºå‰ΩøÁî®WeixinJSBridge");
      WeixinJSBridge.invoke('getNetworkType', {}, () => {
        console.log("ÂæÆ‰ø°Èü≥È¢ëÁéØÂ¢ÉÂáÜÂ§áÂ∞±Áª™");
        this.audioUnlocked = true;
      });
    }
  },
  
  // Ê£ÄÊü•ÊâÄÊúâÈü≥È¢ëÊòØÂê¶Âä†ËΩΩÂÆåÊàê
  checkAllAudioLoaded: function() {
    if (this.sounds.bgMusic && this.sounds.bgMusic.state() === 'loaded' &&
        this.sounds.drinkSound && this.sounds.drinkSound.state() === 'loaded') {
      this.audioLoaded = true;
      console.log("ÊâÄÊúâÈü≥È¢ëËµÑÊ∫êÂä†ËΩΩÂÆåÊàê");
    }
  },
  
  // Ëß£ÈîÅÈü≥È¢ëÔºàÂú®Áî®Êà∑‰∫§‰∫íÊó∂Ë∞ÉÁî®Ôºâ
  unlockAudio: function() {
    if (this.audioUnlocked) return;
    
    console.log("Áî®Êà∑‰∫§‰∫íËß¶ÂèëÈü≥È¢ëËß£ÈîÅ");
    this.audioUnlocked = true;
    
    // Â∞ùËØïÊí≠Êîæ‰∏Ä‰∏™ÊûÅÁü≠ÁöÑÈùôÈü≥Èü≥È¢ëÊù•Ëß£ÈîÅÁ≥ªÁªü
    try {
      const silentAudio = new Howl({
        src: ['data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA='],
        volume: 0,
        onplayerror: () => {
          console.log("ÈùôÈü≥Ëß£ÈîÅÈü≥È¢ëÊí≠ÊîæÂ§±Ë¥•");
        }
      });
      silentAudio.play();
      setTimeout(() => silentAudio.unload(), 100);
    } catch (e) {
      console.log("ÈùôÈü≥Ëß£ÈîÅÂ§±Ë¥•:", e);
    }
    
    // Â¶ÇÊûúÈü≥‰πêÂ∑≤ÂêØÁî®ÔºåÁé∞Âú®Êí≠ÊîæËÉåÊôØÈü≥‰πê
    if (this.musicEnabled) {
      this.playBackgroundMusic();
    }
  },

  // Êí≠ÊîæËÉåÊôØÈü≥‰πê
  playBackgroundMusic: function() {
    if (!this.musicEnabled || !this.audioUnlocked || !this.audioLoaded) return;
    
    const bgMusic = this.sounds.bgMusic;
    if (bgMusic && !bgMusic.playing()) {
      bgMusic.play();
      console.log("ËÉåÊôØÈü≥‰πêÂºÄÂßãÊí≠Êîæ");
    }
  },

  // Êí≠ÊîæÂñùÈÖíÈü≥Êïà
  playDrinkSound: function() {
    if (!this.musicEnabled || !this.audioUnlocked || !this.audioLoaded) return;
    
    const sound = this.sounds.drinkSound;
    if (sound) {
      // ÂÅúÊ≠¢ÂΩìÂâçÊí≠ÊîæÁöÑÈü≥ÊïàÔºàÂ¶ÇÊûúÊúâÔºâÔºåÁÑ∂ÂêéÈáçÊñ∞Êí≠Êîæ
      sound.stop();
      sound.play();
    }
  },

  // ÂàáÊç¢Èü≥‰πêÂºÄÂÖ≥
  toggleMusic: function() {
    this.musicEnabled = !this.musicEnabled;
    const button = document.getElementById('toggleMusic');
    
    if (this.musicEnabled) {
      button.innerHTML = "üîä –ú—É–∑—ã–∫–∞";
      this.playBackgroundMusic();
    } else {
      button.innerHTML = "üîá –ú—É–∑—ã–∫–∞";
      const bgMusic = this.sounds.bgMusic;
      if (bgMusic) {
        bgMusic.pause();
      }
    }
  }
};

// =========================
// Ê∏∏ÊàèÁä∂ÊÄÅÁÆ°ÁêÜ
// =========================

// ÂÖ®Â±ÄÁä∂ÊÄÅ
const GameState = {
  // ÁîªÂ∏ÉÂíåÊ∏∏ÊàèËÆæÁΩÆ
  canvas: document.getElementById('gameCanvas'),
  ctx: null,
  COLS: 12,
  ROWS: 12,
  TILE_SIZE: 60, // Âü∫Á°ÄÊ†ºÂ≠êÂ§ßÂ∞è
  
  // Ê∏∏ÊàèÁä∂ÊÄÅ
  map: [],
  playerX: 0,
  playerY: 0,
  currentLevel: 0,
  drinking: false,
  targetX: null,
  targetY: null,
  moveCount: 0,
  gameActive: false,
  
  // ËµÑÊ∫ê
  images: {},
  resourcesReady: false,
  
  // ÁßªÂä®ÊéßÂà∂Áä∂ÊÄÅ
  isProcessingMove: false,
  mobileControlsActive: false
};

// =========================
// ÂàùÂßãÂåñÁîªÂ∏É
// =========================

function initCanvas() {
  GameState.ctx = GameState.canvas.getContext('2d');
  
  // Ê†πÊçÆËÆæÂ§áÁ±ªÂûãËÆæÁΩÆÁîªÂ∏ÉÂ§ßÂ∞è
  const isMobile = document.body.classList.contains('mobile-device');
  
  if (isMobile) {
    // ÊâãÊú∫ÁâàÔºö‰ΩøÁî®ËæÉÂ∞èÁöÑÂõ∫ÂÆöÂ∞∫ÂØ∏ÔºåÁ°Æ‰øùÊ†ºÂ≠êÂ§ßÂ∞èÊòØÊï¥Êï∞
    const maxSize = Math.min(window.innerWidth, window.innerHeight * 0.7) - 20;
    const size = Math.floor(maxSize / GameState.COLS) * GameState.COLS; // Á°Æ‰øùËÉΩË¢´ÂàóÊï∞Êï¥Èô§
    
    GameState.canvas.width = size;
    GameState.canvas.height = size;
    GameState.TILE_SIZE = size / GameState.COLS;
    
    console.log(`ÊâãÊú∫Áâà: ÁîªÂ∏ÉÂ§ßÂ∞è ${size}x${size}, Ê†ºÂ≠êÂ§ßÂ∞è ${GameState.TILE_SIZE}`);
  } else {
    // ÁîµËÑëÁâàÔºö‰øùÊåÅÂéüÊúâÂ∞∫ÂØ∏
    GameState.canvas.width = 680;
    GameState.canvas.height = 680;
    GameState.TILE_SIZE = 60;
    console.log(`ÁîµËÑëÁâà: ÁîªÂ∏ÉÂ§ßÂ∞è 680x680, Ê†ºÂ≠êÂ§ßÂ∞è ${GameState.TILE_SIZE}`);
  }
}

// =========================
// ËÆæÂ§áÊ£ÄÊµãÂíåÊ†∑ÂºèÁÆ°ÁêÜ
// =========================

function detectDeviceAndApplyStyles() {
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const urlParams = new URLSearchParams(window.location.search);
  const forceDesktop = urlParams.get('desktop');
  const forceMobile = urlParams.get('mobile');
  
  if (forceDesktop) {
    localStorage.setItem('preferDesktop', 'true');
    localStorage.removeItem('preferMobile');
  } else if (forceMobile) {
    localStorage.setItem('preferMobile', 'true');
    localStorage.removeItem('preferDesktop');
  }
  
  const preferDesktop = localStorage.getItem('preferDesktop') === 'true';
  const preferMobile = localStorage.getItem('preferMobile') === 'true';
  
  if ((isMobile && !preferDesktop) || preferMobile) {
    applyMobileStyles();
  } else {
    applyDesktopStyles();
  }
}

function applyMobileStyles() {
  document.body.classList.add('mobile-device');
  document.body.classList.remove('desktop-device');
  
  // ÊòæÁ§∫ÁßªÂä®ÊéßÂà∂ÊåâÈíÆ
  document.getElementById('mobile-controls').style.display = 'flex';
  const controlButtons = document.querySelectorAll('.control-btn');
  controlButtons.forEach(btn => {
    btn.style.display = 'flex';
  });
  
  GameState.mobileControlsActive = true;
  
  // Ê∑ªÂä†ÁâàÊú¨ÊèêÁ§∫
  if (!document.getElementById('version-notice')) {
    const notice = document.createElement('div');
    notice.id = 'version-notice';
    notice.innerHTML = `
      <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
                 background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; 
                 border-radius: 20px; font-size: 12px; z-index: 1000;">
        üì± ÊâãÊú∫Áâà | <a href="?desktop=true" style="color: #f5c542;">ÂàáÊç¢Âà∞ÁîµËÑëÁâà</a>
      </div>
    `;
    document.body.appendChild(notice);
  }
}

function applyDesktopStyles() {
  document.body.classList.add('desktop-device');
  document.body.classList.remove('mobile-device');
  
  // ÈöêËóèÁßªÂä®ÊéßÂà∂ÊåâÈíÆ
  document.getElementById('mobile-controls').style.display = 'none';
  const controlButtons = document.querySelectorAll('.control-btn');
  controlButtons.forEach(btn => {
    btn.style.display = 'none';
  });
  
  GameState.mobileControlsActive = false;
  
  // Ê∑ªÂä†ÁâàÊú¨ÊèêÁ§∫
  if (!document.getElementById('version-notice')) {
    const notice = document.createElement('div');
    notice.id = 'version-notice';
    notice.innerHTML = `
      <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
                 background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; 
                 border-radius: 20px; font-size: 12px; z-index: 1000;">
        üñ•Ô∏è ÁîµËÑëÁâà | <a href="?mobile=true" style="color: #f5c542;">ÂàáÊç¢Âà∞ÊâãÊú∫Áâà</a>
      </div>
    `;
    document.body.appendChild(notice);
  }
}

// =========================
// ËµÑÊ∫êÂä†ËΩΩ
// =========================

const imagesToLoad = {
  bg: "./images/bg_room.png",
  floor: "./images/floor.png",
  wall: "./images/wall.png",
  player: "./images/player.png",
  box: "./images/opener.png",
  beer: "./images/beer.png",
  drink: "./images/drink.gif",
  emptyBeer: "./images/empty_beer.png"
};

function preloadResources() {
  document.getElementById('loadingOverlay').style.display = 'flex';
  
  let imagesLoaded = 0;
  const totalImages = Object.keys(imagesToLoad).length;
  
  // ËÆæÁΩÆË∂ÖÊó∂‰øùÊä§
  const timeout = setTimeout(() => {
    console.warn("ËµÑÊ∫êÂä†ËΩΩË∂ÖÊó∂ÔºåÂº∫Âà∂ÁªßÁª≠");
    finishLoading();
  }, 10000);
  
  // ÂàùÂßãÂåñÈü≥È¢ëÁ≥ªÁªü
  AudioManager.initSounds();
  
  // Âä†ËΩΩÂõæÁâá
  for (const [key, src] of Object.entries(imagesToLoad)) {
    const img = new Image();
    img.onload = () => {
      imagesLoaded++;
      GameState.images[key] = img;
      console.log(`‚úÖ ÂõæÁâáÂä†ËΩΩ: ${key} (${imagesLoaded}/${totalImages})`);
      checkAllLoaded();
    };
    img.onerror = () => {
      imagesLoaded++;
      console.error(`‚ùå ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•: ${src}`);
      GameState.images[key] = createPlaceholderImage(key);
      checkAllLoaded();
    };
    img.src = src;
  }
  
  function checkAllLoaded() {
    if (imagesLoaded === totalImages && AudioManager.audioLoaded) {
      clearTimeout(timeout);
      finishLoading();
    }
  }
  
  function finishLoading() {
    GameState.resourcesReady = true;
    document.getElementById('loadingOverlay').style.display = 'none';
    console.log("üéâ ÊâÄÊúâËµÑÊ∫êÂä†ËΩΩÂÆåÊàê");
  }
}

function createPlaceholderImage(name) {
  const canvas = document.createElement('canvas');
  canvas.width = 100;
  canvas.height = 100;
  const ctx = canvas.getContext('2d');
  
  const colors = {
    bg: '#1a1a2e', floor: '#2d3047', wall: '#4a4e69',
    player: '#ff6b6b', box: '#f9c74f', beer: '#43aa8b',
    drink: '#277da1', emptyBeer: '#577590'
  };
  
  ctx.fillStyle = colors[name] || '#666';
  ctx.fillRect(0, 0, 100, 100);
  ctx.fillStyle = '#fff';
  ctx.font = '12px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(name, 50, 50);
  
  const img = new Image();
  img.src = canvas.toDataURL();
  return img;
}

// =========================
// ÁßªÂä®ÊéßÂà∂ - Á®≥ÂÆöÁâàÊú¨
// =========================

function setupMobileControls() {
  const controlButtons = document.querySelectorAll('.control-btn');
  
  // ÈáçÁΩÆÊâÄÊúâ‰∫ã‰ª∂ÁõëÂê¨Âô®
  controlButtons.forEach(btn => {
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
  });
  
  // ‰∏∫ÊØè‰∏™ÊåâÈíÆÊ∑ªÂä†Á®≥ÂÆöÁöÑ‰∫ã‰ª∂Â§ÑÁêÜ
  function addControlEvent(buttonId, dx, dy) {
    const button = document.getElementById(buttonId);
    
    const handleMove = (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // Èò≤Ê≠¢ÈáçÂ§çËß¶Âèë
      if (GameState.isProcessingMove) return;
      
      GameState.isProcessingMove = true;
      movePlayer(dx, dy);
      
      // ËÆæÁΩÆÂêàÁêÜÁöÑÂÜ∑Âç¥Êó∂Èó¥
      setTimeout(() => {
        GameState.isProcessingMove = false;
      }, 200);
    };
    
    // ÂêåÊó∂ÁªëÂÆöËß¶Êë∏ÂíåÈº†Ê†á‰∫ã‰ª∂
    button.addEventListener('touchstart', handleMove, { passive: false });
    button.addEventListener('mousedown', handleMove);
    
    // Èò≤Ê≠¢ÈªòËÆ§Ë°å‰∏∫
    button.addEventListener('click', (e) => e.preventDefault());
    button.addEventListener('contextmenu', (e) => e.preventDefault());
  }
  
  addControlEvent('btn-up', 0, -1);
  addControlEvent('btn-down', 0, 1);
  addControlEvent('btn-left', -1, 0);
  addControlEvent('btn-right', 1, 0);
}

// =========================
// Ê∏∏ÊàèÈÄªËæë - Á®≥ÂÆöÁâàÊú¨
// =========================

const LEVELS = [
`############
############
############
#####B######
#####.######
#####O.OB###
###B.OP#####
######O#####
######B#####
############
############
############`,
`############
############
###P..######
###.OO#######
###.O.###B###
#####.###B###
#####....B###
####...#..####
####...########
############
############
############`,
`############
############
############
#####....###
###B.O##.###
##BBO.O..P##
##BB.O.O.###
#######..###
############
############
############
############`,
`############
############
############
#####..#.P##
####...#..##
####O.O.O.##
####.O##..##
####.O.#.###
##BBBBB..###
############
############
############`,
`############
############
############
#####....###
#####OOO.###
###P.OBB.###
###.OBBB####
######..####
############
############
############
############`
].map(s => s.split('\n').map(r => r.split('')));

function loadLevel(id) {
  // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
  GameState.currentLevel = id;
  GameState.map = Array.from({length: GameState.ROWS}, () => Array(GameState.COLS).fill(0));
  GameState.targetX = null;
  GameState.targetY = null;
  GameState.moveCount = 0;
  GameState.drinking = false;
  GameState.isProcessingMove = false;
  
  document.getElementById('moveCount').innerText = GameState.moveCount;
  document.getElementById('currentLevelLabel').innerText = id;
  
  const raw = LEVELS[id-1];
  
  // Ëß£ÊûêÂú∞Âõæ
  for (let y = 0; y < GameState.ROWS; y++) {
    for (let x = 0; x < GameState.COLS; x++) {
      const ch = raw[y][x];
      if (ch === '#') GameState.map[y][x] = 1;
      else if (ch === 'P') { 
        GameState.playerX = x; 
        GameState.playerY = y; 
        GameState.map[y][x] = 0; 
      }
      else if (ch === 'O') GameState.map[y][x] = 3;
      else if (ch === 'B') GameState.map[y][x] = 4;
      else GameState.map[y][x] = 0;
    }
  }
  
  GameState.gameActive = true;
  
  // ÈáçÊñ∞ÂàùÂßãÂåñÁîªÂ∏É
  initCanvas();
  
  // ËÆæÁΩÆÁßªÂä®ÊéßÂà∂ÔºàÂ¶ÇÊûúÊòØÁßªÂä®ËÆæÂ§áÔºâ
  if (GameState.mobileControlsActive) {
    setupMobileControls();
  }
  
  // ÁªòÂà∂Á¨¨‰∏ÄÂ∏ß
  drawFrame();
}

function drawFrame() {
  const ctx = GameState.ctx;
  const canvas = GameState.canvas;
  
  // Ê∏ÖÁ©∫ÁîªÂ∏É
  ctx.fillStyle = '#222';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // ÁªòÂà∂ËÉåÊôØ
  const bg = GameState.images.bg;
  if (bg && bg.complete) {
    const scale = Math.max(canvas.width/bg.width, canvas.height/bg.height);
    const w = bg.width * scale, h = bg.height * scale;
    const bx = (canvas.width - w)/2, by = (canvas.height - h)/2;
    ctx.globalAlpha = 0.5;
    ctx.drawImage(bg, bx, by, w, h);
    ctx.globalAlpha = 1;
  }
  
  // ÁªòÂà∂Âú∞ÂõæÂÖÉÁ¥†
  for (let y = 0; y < GameState.ROWS; y++) {
    for (let x = 0; x < GameState.COLS; x++) {
      const px = x * GameState.TILE_SIZE, py = y * GameState.TILE_SIZE;
      
      // Âú∞Êùø
      if (GameState.images.floor && GameState.images.floor.complete) {
        ctx.drawImage(GameState.images.floor, px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
      } else {
        ctx.fillStyle = '#333';
        ctx.fillRect(px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
      }
      
      // Âï§ÈÖí
      if (GameState.map[y][x] === 4) {
        if (GameState.images.beer && GameState.images.beer.complete) {
          ctx.drawImage(GameState.images.beer, px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
        }
      }
      
      // Á©∫Áì∂Â≠ê
      if (GameState.map[y][x] === 10) {
        if (GameState.images.emptyBeer && GameState.images.emptyBeer.complete) {
          ctx.drawImage(GameState.images.emptyBeer, px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
        }
      }
      
      // Â¢ô
      if (GameState.map[y][x] === 1) {
        if (GameState.images.wall && GameState.images.wall.complete) {
          ctx.drawImage(GameState.images.wall, px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
        } else {
          ctx.fillStyle = '#666';
          ctx.fillRect(px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
        }
      }
      
      // ÁÆ±Â≠ê
      if (GameState.map[y][x] === 3) {
        if (GameState.images.box && GameState.images.box.complete) {
          ctx.drawImage(GameState.images.box, px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
        }
      }
    }
  }
  
  // ÁªòÂà∂Áé©ÂÆ∂ÊàñÂñùÈÖíÂä®Áîª
  const px = GameState.playerX * GameState.TILE_SIZE, py = GameState.playerY * GameState.TILE_SIZE;
  if (GameState.drinking) {
    if (GameState.images.drink && GameState.images.drink.complete) {
      ctx.drawImage(GameState.images.drink, px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
    }
  } else {
    if (GameState.images.player && GameState.images.player.complete) {
      ctx.drawImage(GameState.images.player, px, py, GameState.TILE_SIZE, GameState.TILE_SIZE);
    }
  }
}

// ËæÖÂä©ÂáΩÊï∞
function inBounds(x, y) { 
  return x >= 0 && x < GameState.COLS && y >= 0 && y < GameState.ROWS; 
}

function isWall(x, y) { 
  return !inBounds(x, y) || GameState.map[y][x] === 1; 
}

function isBox(x, y) { 
  return inBounds(x, y) && GameState.map[y][x] === 3; 
}

function isBeer(x, y) { 
  return inBounds(x, y) && GameState.map[y][x] === 4; 
}

function isEmptyBottle(x, y) { 
  return inBounds(x, y) && GameState.map[y][x] === 10; 
}

function isEmpty(x, y) { 
  return inBounds(x, y) && (GameState.map[y][x] === 0); 
}

// ÁßªÂä®ÂáΩÊï∞ - Ê†∏ÂøÉÈÄªËæë
function movePlayer(dx, dy) {
  if (!GameState.gameActive || GameState.drinking) return;
  
  const nx = GameState.playerX + dx, ny = GameState.playerY + dy;
  
  if (isWall(nx, ny)) return;
  
  if (isBox(nx, ny)) {
    const bx = nx + dx, by = ny + dy;
    if (isWall(bx, by) || isBox(bx, by) || isEmptyBottle(bx, by)) return;
    
    if (isBeer(bx, by)) {
      GameState.map[ny][nx] = 0;
      GameState.targetX = bx;
      GameState.targetY = by;
      GameState.map[by][bx] = 0;
      GameState.playerX = nx;
      GameState.playerY = ny;
      GameState.moveCount++;
      document.getElementById('moveCount').innerText = GameState.moveCount;
      startDrinkAnimation();
    } else if (isEmpty(bx, by)) {
      GameState.map[by][bx] = 3;
      GameState.map[ny][nx] = 0;
      GameState.playerX = nx;
      GameState.playerY = ny;
      GameState.moveCount++;
      document.getElementById('moveCount').innerText = GameState.moveCount;
      drawFrame();
      if (checkWin()) showWin();
    }
  } else if (isEmptyBottle(nx, ny)) {
    const bx = nx + dx, by = ny + dy;
    if (isWall(bx, by) || isBox(bx, by)) return;
    
    if (isBeer(bx, by)) {
      GameState.map[by][bx] = 10;
      GameState.map[ny][nx] = 4;
      GameState.playerX = nx;
      GameState.playerY = ny;
      GameState.moveCount++;
      document.getElementById('moveCount').innerText = GameState.moveCount;
      drawFrame();
    } else if (isEmpty(bx, by)) {
      GameState.map[by][bx] = 10;
      GameState.map[ny][nx] = 0;
      GameState.playerX = nx;
      GameState.playerY = ny;
      GameState.moveCount++;
      document.getElementById('moveCount').innerText = GameState.moveCount;
      drawFrame();
    }
  } else {
    if (isEmpty(nx, ny) || isBeer(nx, ny)) {
      GameState.playerX = nx;
      GameState.playerY = ny;
      GameState.moveCount++;
      document.getElementById('moveCount').innerText = GameState.moveCount;
      drawFrame();
    }
  }
}

function startDrinkAnimation() {
  GameState.drinking = true;
  AudioManager.playDrinkSound();
  drawFrame();
  
  setTimeout(() => {
    GameState.drinking = false;
    if (GameState.targetX !== null && GameState.targetY !== null) {
      GameState.map[GameState.targetY][GameState.targetX] = 10;
      GameState.targetX = null;
      GameState.targetY = null;
    }
    drawFrame();
    if (checkWin()) showWin();
  }, 900);
}

function checkWin() {
  for (let y = 0; y < GameState.ROWS; y++) {
    for (let x = 0; x < GameState.COLS; x++) {
      if (GameState.map[y][x] === 4) return false;
    }
  }
  return true;
}

// =========================
// UI ÁÆ°ÁêÜ
// =========================

function hideAllScreens() {
  document.getElementById('main-menu').style.display = 'none';
  document.getElementById('level-select').style.display = 'none';
  document.getElementById('game-container').style.display = 'none';
  document.getElementById('winBox').style.display = 'none';
}

function openMainMenu() { 
  hideAllScreens(); 
  document.getElementById('main-menu').style.display = 'flex'; 
}

function openLevelSelect() { 
  hideAllScreens(); 
  document.getElementById('level-select').style.display = 'flex'; 
}

function openSettings() { 
  alert('–ú—É–∑—ã–∫–∞ ' + (AudioManager.musicEnabled ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞') + '. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤ –∏–≥—Ä–æ–≤–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.'); 
}

function returnToMenu() { 
  GameState.gameActive = false; 
  openMainMenu(); 
}

function restartLevel() { 
  loadLevel(GameState.currentLevel); 
}

function buildLevelButtons() {
  const container = document.getElementById('levelsContainer');
  container.innerHTML = '';
  
  for (let i = 0; i < LEVELS.length; i++) {
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    btn.innerText = `–£—Ä–æ–≤–µ–Ω—å ${i+1}`;
    btn.onclick = () => startLevel(i+1);
    container.appendChild(btn);
  }
}

function startLevel(n) {
  if (!GameState.resourcesReady) {
    document.getElementById('loadingOverlay').style.display = 'flex';
    const checkInterval = setInterval(() => {
      if (GameState.resourcesReady) {
        clearInterval(checkInterval);
        document.getElementById('loadingOverlay').style.display = 'none';
        _startLevel(n);
      }
    }, 100);
  } else {
    _startLevel(n);
  }
}

function _startLevel(n) {
  hideAllScreens();
  document.getElementById('game-container').style.display = 'flex';
  loadLevel(n);
}

// ËÉúÂà©ÂºπÊ°Ü
const winBox = document.getElementById('winBox');
const winText = document.getElementById('winText');
const btnNext = document.getElementById('btnNext');
const btnReplay = document.getElementById('btnReplay');

btnNext.addEventListener('click', () => {
  if (GameState.currentLevel < LEVELS.length) {
    _startLevel(GameState.currentLevel + 1);
    winBox.style.display = 'none';
  } else {
    openLevelSelect();
    winBox.style.display = 'none';
  }
});

btnReplay.addEventListener('click', () => {
  _startLevel(GameState.currentLevel);
  winBox.style.display = 'none';
});

function showWin() {
  winText.innerText = `–£—Ä–æ–≤–µ–Ω—å ${GameState.currentLevel} –ø—Ä–æ–π–¥–µ–Ω!`;
  btnNext.style.display = (GameState.currentLevel < LEVELS.length) ? 'inline-block' : 'none';
  winBox.style.display = 'block';
}

// =========================
// ÈîÆÁõòÊéßÂà∂
// =========================

document.addEventListener('keydown', (e) => {
  if (!GameState.gameActive || GameState.drinking) return;
  
  switch(e.key) {
    case 'ArrowUp': movePlayer(0, -1); break;
    case 'ArrowDown': movePlayer(0, 1); break;
    case 'ArrowLeft': movePlayer(-1, 0); break;
    case 'ArrowRight': movePlayer(1, 0); break;
  }
});

// =========================
// Èò≤Ê≠¢È°µÈù¢Áº©ÊîæÂíåÊªöÂä®
// =========================

document.addEventListener('touchmove', function(e) {
  if (e.scale !== 1) {
    e.preventDefault();
  }
}, { passive: false });

document.body.addEventListener('touchmove', function(e) {
  if (e.target.classList.contains('control-btn')) {
    return;
  }
  e.preventDefault();
}, { passive: false });

// =========================
// È°µÈù¢ÂàùÂßãÂåñ
// =========================

window.onload = function() {
  // 1. Ê£ÄÊµãËÆæÂ§áÂπ∂Â∫îÁî®Ê†∑Âºè
  detectDeviceAndApplyStyles();
  
  // 2. ÂàùÂßãÂåñÁîªÂ∏É
  initCanvas();
  
  // 3. È¢ÑÂä†ËΩΩËµÑÊ∫ê
  preloadResources();
  
  // 4. ÊûÑÂª∫UI
  buildLevelButtons();
  openMainMenu();
  
  // 5. ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
  document.getElementById('toggleMusic').addEventListener('click', function() {
    AudioManager.toggleMusic();
  });
  
  document.getElementById('startGameBtn').addEventListener('click', function() {
    AudioManager.unlockAudio();
    openLevelSelect();
  });
  
  document.getElementById('levelSelectBtn').addEventListener('click', function() {
    AudioManager.unlockAudio();
    openLevelSelect();
  });
  
  // 6. ÂÖ®Â±ÄÁî®Êà∑‰∫§‰∫íÁõëÂê¨Âô®
  document.addEventListener('click', function() {
    AudioManager.unlockAudio();
  });
  
  document.addEventListener('touchstart', function() {
    AudioManager.unlockAudio();
  });
  
  // 7. ÁªòÂà∂ÂàùÂßãÁîªÂ∏É
  GameState.ctx.fillStyle = '#111';
  GameState.ctx.fillRect(0, 0, GameState.canvas.width, GameState.canvas.height);
  
  console.log("Ê∏∏ÊàèÂàùÂßãÂåñÂÆåÊàê");
};
</script>
</body>
</html>