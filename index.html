<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<title>ĞŸĞ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¡Ğ¾ĞºĞ¾Ğ±Ğ°Ğ½ - ĞŸĞ¸Ğ²Ğ½Ğ°Ñ Ğ¸Ğ³Ñ€Ğ° Ğ¡Ğ¾ĞºĞ¾Ğ±Ğ°Ğ½</title>

<script>
// è®¾å¤‡æ£€æµ‹å‡½æ•°
function detectDeviceAndRedirect() {
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const urlParams = new URLSearchParams(window.location.search);
  const forceDesktop = urlParams.get('desktop');
  const forceMobile = urlParams.get('mobile');
  
  // å¦‚æœå¼ºåˆ¶æ¡Œé¢ç‰ˆæˆ–å¼ºåˆ¶æ‰‹æœºç‰ˆï¼Œè®¾ç½®æ ‡å¿—
  if (forceDesktop) {
    localStorage.setItem('preferDesktop', 'true');
    localStorage.removeItem('preferMobile');
  } else if (forceMobile) {
    localStorage.setItem('preferMobile', 'true');
    localStorage.removeItem('preferDesktop');
  }
  
  const preferDesktop = localStorage.getItem('preferDesktop') === 'true';
  const preferMobile = localStorage.getItem('preferMobile') === 'true';
  
  // åº”ç”¨ç›¸åº”æ ·å¼
  if ((isMobile && !preferDesktop) || preferMobile) {
    applyMobileStyles();
  } else {
    applyDesktopStyles();
  }
}

// åº”ç”¨ç§»åŠ¨ç«¯æ ·å¼
function applyMobileStyles() {
  document.body.classList.add('mobile-device');
  
  const mobileCSS = `
    /* ç§»åŠ¨ç«¯æ ·å¼è¦†ç›– */
    .mobile-device #gameCanvas {
      max-width: 100% !important;
      max-height: 65vh !important;
      width: auto !important;
      height: auto !important;
    }
    
    .mobile-device #mobile-controls {
      display: flex !important;
    }
    
    .mobile-device #hud {
      font-size: 14px;
      left: 10px;
      top: 10px;
      background: rgba(0,0,0,0.8);
      padding: 8px;
      border-radius: 6px;
    }
    
    .mobile-device #hud button {
      padding: 6px 10px;
      font-size: 12px;
      min-height: 36px;
    }
    
    .mobile-device #music-control {
      right: 10px;
      top: 10px;
      background: rgba(0,0,0,0.8);
      padding: 5px;
      border-radius: 6px;
    }
    
    .mobile-device .control-btn {
      width: 65px !important;
      height: 65px !important;
      font-size: 24px !important;
      margin: 6px !important;
      background: rgba(0,0,0,0.7) !important;
      border: 2px solid rgba(255,255,255,0.4) !important;
      border-radius: 50% !important;
    }
    
    .mobile-device .screen {
      padding: 10px;
    }
    
    .mobile-device h1 {
      font-size: 32px !important;
      text-align: center;
    }
    
    .mobile-device button {
      min-height: 44px;
      font-size: 16px;
    }
    
    .mobile-device .level-btn {
      width: 110px;
      height: 75px;
      font-size: 14px;
    }
    
    .mobile-device .info {
      font-size: 12px;
      text-align: center;
      padding: 0 10px;
    }
  `;
  
  const style = document.createElement('style');
  style.id = 'mobile-styles';
  style.textContent = mobileCSS;
  document.head.appendChild(style);
  
  // æ·»åŠ ç‰ˆæœ¬åˆ‡æ¢æç¤º
  if (!document.getElementById('version-notice')) {
    const notice = document.createElement('div');
    notice.id = 'version-notice';
    notice.innerHTML = `
      <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
                 background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; 
                 border-radius: 20px; font-size: 12px; z-index: 1000;">
        ğŸ“± æ‰‹æœºç‰ˆ | <a href="?desktop=true" style="color: #f5c542;">åˆ‡æ¢åˆ°ç”µè„‘ç‰ˆ</a>
      </div>
    `;
    document.body.appendChild(notice);
  }
}

// åº”ç”¨æ¡Œé¢ç«¯æ ·å¼
function applyDesktopStyles() {
  document.body.classList.add('desktop-device');
  
  // ç§»é™¤ç§»åŠ¨ç«¯æ ·å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const mobileStyles = document.getElementById('mobile-styles');
  if (mobileStyles) {
    mobileStyles.remove();
  }
  
  // æ·»åŠ ç‰ˆæœ¬åˆ‡æ¢æç¤º
  if (!document.getElementById('version-notice')) {
    const notice = document.createElement('div');
    notice.id = 'version-notice';
    notice.innerHTML = `
      <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
                 background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; 
                 border-radius: 20px; font-size: 12px; z-index: 1000;">
        ğŸ–¥ï¸ ç”µè„‘ç‰ˆ | <a href="?mobile=true" style="color: #f5c542;">åˆ‡æ¢åˆ°æ‰‹æœºç‰ˆ</a>
      </div>
    `;
    document.body.appendChild(notice);
  }
}

// é¡µé¢åŠ è½½æ—¶æ£€æµ‹è®¾å¤‡
window.addEventListener('load', function() {
  detectDeviceAndRedirect();
  
  // å»¶è¿Ÿæ·»åŠ ç§»åŠ¨æ§åˆ¶æŒ‰é’®ï¼Œç¡®ä¿DOMå·²åŠ è½½
  setTimeout(addMobileControls, 100);
});
</script>

<style>
  :root { --bg:#0f1113; --panel:#111; --accent:#f5c542; }
  html,body{
    height:100%;
    margin:0;
    padding:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:#fff;
    text-size-adjust:100%;
    -webkit-text-size-adjust:100%;
    overflow: hidden;
    touch-action: manipulation;
  }
  
  /* åŸºç¡€æ ·å¼ */
  .screen{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    -webkit-user-select:none;
    user-select:none;
    padding: 20px;
    box-sizing: border-box;
  }
  
  button{
    cursor:pointer;
    border:none;
    border-radius:8px;
    padding:12px 20px;
    margin:6px;
    background:#333;
    color:#fff;
    font-size:18px;
    -webkit-user-select:none;
    user-select:none;
    min-height: 44px;
  }
  
  h1{margin:8px; text-align:center;}
  
  /* ä¸»èœå• */
  #main-menu{display:flex}
  
  /* å…³å¡é€‰æ‹© */
  #level-select .levels{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    justify-content:center;
    max-width: 920px;
    padding: 10px;
  }
  
  .level-btn{
    width: 160px;
    height: 80px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#222;
    border-radius:8px;
    font-size:16px;
  }
  
  /* æ¸¸æˆå®¹å™¨ */
  #game-container{
    display:flex;
    background:#000;
    align-items:center;
    justify-content:center;
    width: 100%;
    height: 100%;
    position: relative;
  }
  
  #gameCanvas {
    width: 680px;
    height: 680px;
  }
  
  /* HUD */
  #hud{
    position:absolute;
    left:18px;
    top:18px;
    z-index:30;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  
  #hud button{
    padding:6px 10px;
    font-size:14px;
  }
  
  /* ç§»åŠ¨æ§åˆ¶æŒ‰é’® - é»˜è®¤éšè— */
  #mobile-controls{
    position: fixed;
    bottom: 20px;
    left: 0;
    right: 0;
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 40;
    touch-action: manipulation;
  }
  
  .control-row{
    display: flex;
    justify-content: center;
    margin: 5px 0;
  }
  
  .control-btn{
    width: 70px;
    height: 70px;
    margin: 8px;
    font-size: 28px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
    display: none; /* é»˜è®¤éšè— */
  }
  
  /* èƒœåˆ©æ¡† */
  #winBox{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    background:rgba(255,255,255,0.96);
    color:#222;
    padding:20px 26px;
    border-radius:10px;
    display:none;
    z-index:60;
    text-align:center;
    -webkit-user-select:none;
    user-select:none;
    max-width: 400px;
    width: 90%;
    box-sizing: border-box;
  }
  
  #winBox button{
    margin:6px;
    width: 100%;
    max-width: 200px;
  }
  
  /* loading overlay */
  #loadingOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
    color:#fff
  }
  
  /* small info */
  .info {
    opacity:0.85;
    font-size:13px;
    text-align: center;
    padding: 0 10px;
    margin: 5px 0;
  }
  
  /* éŸ³ä¹æ§åˆ¶ */
  #music-control{
    position:absolute;
    right:18px;
    top:18px;
    z-index:30;
  }
  
  #music-control button{
    background:rgba(0,0,0,0.7);
    color:#fff;
    font-size: 14px;
    padding: 8px 12px;
  }
</style>
</head>
<body>

<!-- ä¸»èœå• -->
<div id="main-menu" class="screen">
  <h1 style="font-size:56px">ğŸº ĞŸĞ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¡Ğ¾ĞºĞ¾Ğ±Ğ°Ğ½</h1>
  <div style="display:flex;flex-direction:column;align-items:center">
    <div style="margin-bottom:14px">
      <button id="startGameBtn">ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ</button>
      <button id="levelSelectBtn">Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ</button>
      <button onclick="openSettings()">ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
    </div>
    <div class="info">Ğ¦ĞµĞ»ÑŒ: Ğ¢Ğ¾Ğ»ĞºĞ°Ğ¹Ñ‚Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ÑˆĞºĞ¸ (ÑÑ‰Ğ¸ĞºĞ¸) Ğ½Ğ° Ğ¿Ğ¸Ğ²Ğ¾ â†’ Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¸Ñ‚ÑŒÑ â†’ Ğ’Ñ‹Ğ¿ĞµĞ¹Ñ‚Ğµ Ğ²ÑÑ‘ Ğ¿Ğ¸Ğ²Ğ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ñ‚Ğ¸ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ</div>
    <div class="info">ĞĞ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ: Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ‚Ğ¾Ğ»ĞºĞ°Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ Ğ±ÑƒÑ‚Ñ‹Ğ»ĞºĞ¸!</div>
  </div>
</div>

<!-- å…³å¡é€‰æ‹© -->
<div id="level-select" class="screen">
  <h1 style="font-size:44px">Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ</h1>
  <div class="levels" id="levelsContainer" style="margin:18px"></div>
  <div style="margin-top:16px">
    <button onclick="returnToMenu()">Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ</button>
  </div>
</div>

<!-- æ¸¸æˆç•Œé¢ -->
<div id="game-container" class="screen">
  <div style="position:relative">
    <canvas id="gameCanvas" width="680" height="680"></canvas>
    <div id="hud" style="">
      <div>Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ <span id="currentLevelLabel">1</span></div>
      <div>Ğ¨Ğ°Ğ³Ğ¸: <span id="moveCount">0</span></div>
      <div><button onclick="restartLevel()">Ğ¡Ğ±Ñ€Ğ¾Ñ</button><button onclick="openLevelSelect()">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ</button></div>
    </div>
    <div id="music-control">
      <button id="toggleMusic">ğŸ”Š ĞœÑƒĞ·Ñ‹ĞºĞ°</button>
    </div>
    
    <!-- ç§»åŠ¨æ§åˆ¶æŒ‰é’® -->
    <div id="mobile-controls">
      <div class="control-row">
        <button class="control-btn" id="btn-up">â†‘</button>
      </div>
      <div class="control-row">
        <button class="control-btn" id="btn-left">â†</button>
        <button class="control-btn" id="btn-down">â†“</button>
        <button class="control-btn" id="btn-right">â†’</button>
      </div>
    </div>
  </div>
</div>

<!-- èƒœåˆ©æç¤º -->
<div id="winBox">
  <div id="winText" style="font-size:18px;margin-bottom:10px">ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼! Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½!</div>
  <div>
    <button id="btnNext">Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ</button>
    <button id="btnReplay">ĞŸĞµÑ€ĞµĞ¸Ğ³Ñ€Ğ°Ñ‚ÑŒ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ</button>
    <button onclick="openLevelSelect()">Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ</button>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay"><div style="text-align:center"><h2>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²â€¦</h2></div></div>

<script>
// æ·»åŠ ç§»åŠ¨æ§åˆ¶åŠŸèƒ½
function addMobileControls() {
  // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
  document.getElementById('mobile-controls').style.display = 'flex';
  const controlButtons = document.querySelectorAll('.control-btn');
  controlButtons.forEach(btn => {
    btn.style.display = 'flex';
  });
  
  // æ·»åŠ è§¦æ‘¸äº‹ä»¶
  document.getElementById('btn-up').addEventListener('touchstart', (e) => {
    e.preventDefault();
    movePlayer(0, -1);
  });
  
  document.getElementById('btn-down').addEventListener('touchstart', (e) => {
    e.preventDefault();
    movePlayer(0, 1);
  });
  
  document.getElementById('btn-left').addEventListener('touchstart', (e) => {
    e.preventDefault();
    movePlayer(-1, 0);
  });
  
  document.getElementById('btn-right').addEventListener('touchstart', (e) => {
    e.preventDefault();
    movePlayer(1, 0);
  });
  
  // é˜²æ­¢æŒ‰é’®é•¿æŒ‰å‡ºç°æ–‡æœ¬é€‰æ‹©
  controlButtons.forEach(btn => {
    btn.addEventListener('contextmenu', (e) => e.preventDefault());
  });
}

/* =========================
   é…ç½®ä¸èµ„æº
   ========================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 60;      // 12 * 60 = 720
const COLS = 12, ROWS = 12;

const imagesToLoad = {
  bg: "./images/bg_room.png",
  floor: "./images/floor.png",
  wall: "./images/wall.png",
  player: "./images/player.png",
  box: "./images/opener.png",
  beer: "./images/beer.png",
  drink: "./images/drink.gif",
  emptyBeer: "./images/empty_beer.png"
};

// æ·»åŠ éŸ³é¢‘èµ„æº
const audioToLoad = {
  bgMusic: "./audio/background-music.mp3",
  drinkSound: "./audio/drink-sound.mp3"
};

let imgs = {};
let audio = {};
let loaded = 0, totalImgs = Object.keys(imagesToLoad).length;
let audioLoaded = 0, totalAudio = Object.keys(audioToLoad).length;
let resourcesReady = false;

// éŸ³é¢‘çŠ¶æ€
let musicEnabled = true; // é»˜è®¤å¯ç”¨éŸ³ä¹
let audioInitialized = false;

// åˆå§‹åŒ–éŸ³é¢‘
function initAudio() {
  if (audioInitialized) return;
  
  // è®¾ç½®éŸ³é¢‘å±æ€§
  if (audio.bgMusic) {
    audio.bgMusic.loop = true;
    audio.bgMusic.volume = 0.3;
  }
  
  if (audio.drinkSound) {
    audio.drinkSound.volume = 0.7;
  }
  
  audioInitialized = true;
  console.log("ĞÑƒĞ´Ğ¸Ğ¾ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾");
}

// æ’­æ”¾èƒŒæ™¯éŸ³ä¹
function playBackgroundMusic() {
  if (!musicEnabled || !audio.bgMusic) return;
  
  // é‡ç½®å¹¶æ’­æ”¾éŸ³ä¹
  audio.bgMusic.currentTime = 0;
  audio.bgMusic.play().catch(e => {
    console.log("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ¼ÑƒĞ·Ñ‹ĞºĞ¸:", e);
  });
}

// æ’­æ”¾å–å•¤é…’éŸ³æ•ˆ
function playDrinkSound() {
  if (!musicEnabled || !audio.drinkSound) return;
  
  audio.drinkSound.currentTime = 0;
  audio.drinkSound.play().catch(e => {
    console.log("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ğ·Ğ²ÑƒĞºĞ° Ğ¿Ğ¸Ñ‚ÑŒÑ:", e);
  });
}

// åˆ‡æ¢éŸ³ä¹
function toggleMusic() {
  musicEnabled = !musicEnabled;
  const button = document.getElementById('toggleMusic');
  
  if (musicEnabled) {
    button.innerHTML = "ğŸ”Š ĞœÑƒĞ·Ñ‹ĞºĞ°";
    playBackgroundMusic();
  } else {
    button.innerHTML = "ğŸ”‡ ĞœÑƒĞ·Ñ‹ĞºĞ°";
    if (audio.bgMusic) {
      audio.bgMusic.pause();
    }
  }
}

// ç”¨æˆ·äº¤äº’ååˆå§‹åŒ–éŸ³é¢‘
function initAudioOnUserInteraction() {
  if (!audioInitialized) {
    initAudio();
  }
  playBackgroundMusic();
}

function preload() {
  document.getElementById('loadingOverlay').style.display = 'flex';
  
  // é¢„åŠ è½½å›¾ç‰‡
  for (const k in imagesToLoad) {
    const img = new Image();
    img.src = imagesToLoad[k];
    img.onload = () => {
      loaded++;
      console.log(`Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ: ${k}`);
      if (loaded === totalImgs && audioLoaded === totalAudio) {
        resourcesReady = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        initAudio();
        console.log("Ğ’ÑĞµ Ñ€ĞµÑÑƒÑ€ÑÑ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹");
      }
    };
    img.onerror = () => {
      console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ:", imagesToLoad[k]);
      loaded++;
      if (loaded === totalImgs && audioLoaded === totalAudio) {
        resourcesReady = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        initAudio();
      }
    };
    imgs[k] = img;
  }
  
  // é¢„åŠ è½½éŸ³é¢‘
  for (const k in audioToLoad) {
    const sound = new Audio();
    sound.src = audioToLoad[k];
    sound.preload = "auto";
    sound.oncanplaythrough = () => {
      audioLoaded++;
      console.log(`Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ°ÑƒĞ´Ğ¸Ğ¾: ${k}`);
      if (loaded === totalImgs && audioLoaded === totalAudio) {
        resourcesReady = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        initAudio();
      }
    };
    sound.onerror = () => {
      console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ°ÑƒĞ´Ğ¸Ğ¾:", audioToLoad[k]);
      audioLoaded++;
      if (loaded === totalImgs && audioLoaded === totalAudio) {
        resourcesReady = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        initAudio();
      }
    };
    audio[k] = sound;
  }
}
preload();

/* =========================
   5 ä¸ªé‡æ–°è®¾è®¡çš„ 12x12 å…³å¡ï¼ˆå­—ç¬¦åœ°å›¾ï¼‰
   ========================= */

const LEVELS = [
`############
############
############
#####B######
#####.######
#####O.OB###
###B.OP#####
######O#####
######B#####
############
############
############`,
/* Level 2 */
`############
############
###P..######
###.OO#######
###.O.###B###
#####.###B###
#####....B###
####...#..####
####...########
############
############
############`,
/* Level 3 - é‡æ–°è®¾è®¡ä¸ºæ­£å¸¸æ¨ç®±å­å…³å¡ */
`############
############
############
#####....###
###B.O##.###
##BBO.O..P##
##BB.O.O.###
#######..###
############
############
############
############`,
/* Level 4 - é‡æ–°è®¾è®¡ä¸ºæ­£å¸¸æ¨ç®±å­å…³å¡ */
`############
############
############
#####..#.P##
####...#..##
####O.O.O.##
####.O##..##
####.O.#.###
##BBBBB..###
############
############
############`,
/* Level 5 - é‡æ–°è®¾è®¡ä¸ºæ­£å¸¸æ¨ç®±å­å…³å¡ */
`############
############
############
#####....###
#####OOO.###
###P.OBB.###
###.OBBB####
######..####
############
############
############
############`
].map(s => s.split('\n').map(r => r.split('')));

/* =========================
   è¿è¡Œæ—¶æ•°æ®ç»“æ„ä¸çŠ¶æ€
   ========================= */
let map = [];            // 2D numeric map: 0 floor,1 wall,3 box,4 beer,10 emptyBeer placeholder
let playerX = 0, playerY = 0;
let currentLevel = 0;
let drinking = false;
let targetX = null, targetY = null; // where beer was
let moveCount = 0;
let gameActive = false;

/* =========================
   å¸®åŠ©ï¼šä»å­—ç¬¦åœ°å›¾åŠ è½½ map
   ========================= */
function loadLevel(id) {
  currentLevel = id;
  const raw = LEVELS[id-1];
  map = Array.from({length:ROWS}, () => Array(COLS).fill(0));
  targetX = targetY = null;
  moveCount = 0;
  document.getElementById('moveCount').innerText = moveCount;
  document.getElementById('currentLevelLabel').innerText = id;

  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      const ch = raw[y][x];
      if (ch === '#') map[y][x] = 1;
      else if (ch === 'P') { playerX = x; playerY = y; map[y][x] = 0; }
      else if (ch === 'O') map[y][x] = 3;
      else if (ch === 'B') map[y][x] = 4;
      else map[y][x] = 0;
    }
  }
  gameActive = true;
  drinking = false;
  // æ¸²æŸ“é¦–å¸§
  drawFrame();
}

/* =========================
   ç»˜åˆ¶ï¼šèƒŒæ™¯ã€åœ°æ¿ã€å¢™ã€ç®±å­ã€å•¤é…’ã€ç©ºç“¶ã€ç©å®¶æˆ–å–é…’åŠ¨ç”»
   ========================= */
function drawFrame() {
  // èƒŒæ™¯ fill
  ctx.fillStyle = '#222';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // draw background image scaled as cover under tiles
  const bg = imgs.bg;
  if (bg && bg.complete) {
    const scale = Math.max(canvas.width/bg.width, canvas.height/bg.height);
    const w = bg.width * scale, h = bg.height * scale;
    const bx = (canvas.width - w)/2, by = (canvas.height - h)/2;
    ctx.globalAlpha = 0.5;
    ctx.drawImage(bg, bx, by, w, h);
    ctx.globalAlpha = 1;
  }

  // tiles
  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      const px = x * TILE, py = y * TILE;
      // floor
      if (imgs.floor && imgs.floor.complete) ctx.drawImage(imgs.floor, px, py, TILE, TILE);
      else { ctx.fillStyle='#333'; ctx.fillRect(px,py,TILE,TILE); }

      // beer (target) - draw before box so box covers it
      if (map[y][x] === 4) {
        if (imgs.beer && imgs.beer.complete) ctx.drawImage(imgs.beer, px, py, TILE, TILE);
      }
      // empty beer (after drinking) stored as 10
      if (map[y][x] === 10) {
        if (imgs.emptyBeer && imgs.emptyBeer.complete) ctx.drawImage(imgs.emptyBeer, px, py, TILE, TILE);
      }
      // walls
      if (map[y][x] === 1) {
        if (imgs.wall && imgs.wall.complete) ctx.drawImage(imgs.wall, px, py, TILE, TILE);
        else { ctx.fillStyle='#666'; ctx.fillRect(px,py,TILE,TILE); }
      }
      // boxes
      if (map[y][x] === 3) {
        if (imgs.box && imgs.box.complete) ctx.drawImage(imgs.box, px, py, TILE, TILE);
      }
    }
  }

  // player or drinking animation
  const px = playerX * TILE, py = playerY * TILE;
  if (drinking) {
    if (imgs.drink && imgs.drink.complete) ctx.drawImage(imgs.drink, px, py, TILE, TILE);
  } else {
    if (imgs.player && imgs.player.complete) ctx.drawImage(imgs.player, px, py, TILE, TILE);
  }
}

/* =========================
   è¾…åŠ©ï¼šåœ°å›¾åæ ‡æœ‰æ•ˆä¸å¯èµ°æ£€æµ‹
   ========================= */
function inBounds(x,y){ return x>=0 && x<COLS && y>=0 && y<ROWS; }
function isWall(x,y) { return !inBounds(x,y) || map[y][x] === 1; }
function isBox(x,y) { return inBounds(x,y) && map[y][x] === 3; }
function isBeer(x,y) { return inBounds(x,y) && map[y][x] === 4; }
function isEmptyBottle(x,y) { return inBounds(x,y) && map[y][x] === 10; }
function isEmpty(x,y) { return inBounds(x,y) && (map[y][x] === 0); }

/* =========================
   ç§»åŠ¨å‡½æ•° - è¢«é”®ç›˜å’Œè§¦æ‘¸äº‹ä»¶å…±ç”¨
   ========================= */
function movePlayer(dx, dy) {
  if (!gameActive || drinking) return;
  
  const nx = playerX + dx, ny = playerY + dy;
  if (isWall(nx,ny)) return;

  // push case - ç®±å­
  if (isBox(nx,ny)) {
    const bx = nx + dx, by = ny + dy;
    if (isWall(bx,by) || isBox(bx,by) || isEmptyBottle(bx,by)) return; // cannot push
    // if pushing into a beer
    if (isBeer(bx,by)) {
      // remove box from its tile
      map[ny][nx] = 0;
      // record target location
      targetX = bx; targetY = by;
      // remove beer visually (we'll set empty after drinking)
      map[by][bx] = 0;
      // move player into box's previous spot
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      // start drink animation
      startDrinkAnimation();
    } else if (isEmpty(bx,by)) {
      // standard push
      map[by][bx] = 3;
      map[ny][nx] = 0;
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
      // after move check win (if no beers left)
      if (checkWin()) showWin();
    }
  } 
  // push case - ç©ºé…’ç“¶
  else if (isEmptyBottle(nx,ny)) {
    const bx = nx + dx, by = ny + dy;
    if (isWall(bx,by) || isBox(bx,by)) return; // cannot push into wall or box
    
    // if pushing into a beer, swap positions
    if (isBeer(bx,by)) {
      // swap empty bottle and beer
      map[by][bx] = 10; // beer position becomes empty bottle
      map[ny][nx] = 4;  // empty bottle position becomes beer
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    } 
    // if pushing into empty space
    else if (isEmpty(bx,by)) {
      // move empty bottle
      map[by][bx] = 10;
      map[ny][nx] = 0;
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    }
  } 
  // ç§»åŠ¨ç©å®¶åˆ°ç©ºåœ°æ¿æˆ–å•¤é…’ä½ç½®
  else {
    if (isEmpty(nx,ny) || isBeer(nx,ny)) {
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    }
  }
}

/* =========================
   é”®ç›˜äº‹ä»¶ï¼šç§»åŠ¨ + æ¨ç®±å­åˆ°å•¤é…’è§¦å‘å–é…’
   ========================= */
document.addEventListener('keydown', (e) => {
  if (!gameActive) return;
  if (drinking) return;
  let dx = 0, dy = 0;
  if (e.key === 'ArrowUp') { dy = -1; movePlayer(0, -1); }
  else if (e.key === 'ArrowDown') { dy = 1; movePlayer(0, 1); }
  else if (e.key === 'ArrowLeft') { dx = -1; movePlayer(-1, 0); }
  else if (e.key === 'ArrowRight') { dx = 1; movePlayer(1, 0); }
});

/* =========================
   å–é…’åŠ¨ç”»ï¼šæ’­æ”¾ GIFï¼ˆdrinks) ä¸€æ®µæ—¶é—´ï¼Œä¹‹ååœ¨ target æ”¾ empty beer
   ========================= */
function startDrinkAnimation(){
  drinking = true;
  playDrinkSound(); // æ’­æ”¾å–å•¤é…’éŸ³æ•ˆ
  drawFrame();
  // duration: adjust if your drink.gif longer; 900ms is reasonable
  setTimeout(() => {
    drinking = false;
    if (targetX !== null && targetY !== null) {
      map[targetY][targetX] = 10; // empty beer shows
      targetX = targetY = null;
    }
    drawFrame();
    // æ£€æŸ¥èƒœåˆ©ï¼ˆå¦‚æœæ²¡æœ‰ B å‰©ä¸‹ï¼‰
    if (checkWin()) showWin();
  }, 900);
}

/* =========================
   èƒœåˆ©æ£€æµ‹ï¼ˆåœ°å›¾é‡Œæ²¡æœ‰å•¤é…’ Bï¼‰
   ========================= */
function checkWin(){
  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      if (map[y][x] === 4) return false;
    }
  }
  return true;
}

/* =========================
   UI: èœå• / å…³å¡ / æ§åˆ¶
   ========================= */
function hideAllScreens(){
  document.getElementById('main-menu').style.display = 'none';
  document.getElementById('level-select').style.display = 'none';
  document.getElementById('game-container').style.display = 'none';
  document.getElementById('winBox').style.display = 'none';
}
function openMainMenu(){ 
  hideAllScreens(); 
  document.getElementById('main-menu').style.display = 'flex'; 
}
function openLevelSelect(){ 
  hideAllScreens(); 
  document.getElementById('level-select').style.display = 'flex'; 
}
function openSettings(){ 
  // åœ¨è®¾ç½®ä¸­æ˜¾ç¤ºéŸ³ä¹å¼€å…³
  alert('ĞœÑƒĞ·Ñ‹ĞºĞ° ' + (musicEnabled ? 'Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ°' : 'Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ğ°') + '. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ² Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¼ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞµ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ.'); 
}
function returnToMenu(){ 
  gameActive = false; 
  openMainMenu(); 
}
function restartLevel(){ 
  loadLevel(currentLevel); 
  drawFrame(); 
}

/* å¡«å……å…³å¡é€‰æ‹©æŒ‰é’® */
function buildLevelButtons(){
  const container = document.getElementById('levelsContainer');
  container.innerHTML = '';
  for (let i=0;i<LEVELS.length;i++){
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    btn.innerText = `Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ${i+1}`;
    btn.onclick = () => { startLevel(i+1); };
    container.appendChild(btn);
  }
}

/* å¼€å§‹é€‰å®šå…³å¡ï¼ˆå¸¦èµ„æºåŠ è½½ç­‰å¾…ï¼‰ */
function startLevel(n){
  if (!resourcesReady) {
    document.getElementById('loadingOverlay').style.display = 'flex';
    const t = setInterval(()=>{
      if (resourcesReady) { 
        clearInterval(t); 
        document.getElementById('loadingOverlay').style.display='none'; 
        _startLevel(n); 
      }
    },100);
  } else _startLevel(n);
}
function _startLevel(n){
  hideAllScreens();
  document.getElementById('game-container').style.display = 'flex';
  loadLevel(n);
}

/* èƒœåˆ©å¼¹æ¡† */
const winBox = document.getElementById('winBox');
const winText = document.getElementById('winText');
const btnNext = document.getElementById('btnNext');
const btnReplay = document.getElementById('btnReplay');

btnNext.addEventListener('click', ()=> {
  if (currentLevel < LEVELS.length) {
    _startLevel(currentLevel+1);
    winBox.style.display = 'none';
  } else {
    openLevelSelect();
    winBox.style.display = 'none';
  }
});
btnReplay.addEventListener('click', ()=> {
  _startLevel(currentLevel);
  winBox.style.display = 'none';
});

function showWin(){
  winText.innerText = `Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ${currentLevel} Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½!`;
  btnNext.style.display = (currentLevel < LEVELS.length) ? 'inline-block' : 'none';
  winBox.style.display = 'block';
}

/* é¡µé¢åˆå§‹åŒ– */
window.onload = () => {
  buildLevelButtons();
  openMainMenu();
  
  // æ·»åŠ éŸ³ä¹åˆ‡æ¢æŒ‰é’®äº‹ä»¶ç›‘å¬
  document.getElementById('toggleMusic').addEventListener('click', toggleMusic);
  
  // ä¸ºä¸»èœå•æŒ‰é’®æ·»åŠ éŸ³é¢‘åˆå§‹åŒ–
  document.getElementById('startGameBtn').addEventListener('click', function() {
    initAudioOnUserInteraction();
    openLevelSelect();
  });
  
  document.getElementById('levelSelectBtn').addEventListener('click', function() {
    initAudioOnUserInteraction();
    openLevelSelect();
  });
  
  // draw initial blank canvas
  ctx.fillStyle = '#111';
  ctx.fillRect(0,0,canvas.width,canvas.height);
};

// é˜²æ­¢é¡µé¢ç¼©æ”¾å’Œæ»šåŠ¨
document.addEventListener('touchmove', function(e) {
  if (e.scale !== 1) {
    e.preventDefault();
  }
}, { passive: false });

document.body.addEventListener('touchmove', function(e) {
  if (e.target.classList.contains('control-btn')) {
    // å…è®¸æ§åˆ¶æŒ‰é’®çš„è§¦æ‘¸ç§»åŠ¨
    return;
  }
  e.preventDefault();
}, { passive: false });

</script>
</body>
</html>