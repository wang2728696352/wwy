<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="X-Content-Type-Options" content="nosniff" />
<title>–ü–∏–≤–Ω–æ–π –°–æ–∫–æ–±–∞–Ω - –ü–∏–≤–Ω–∞—è –∏–≥—Ä–∞ –°–æ–∫–æ–±–∞–Ω</title>
<style>
  :root { --bg:#0f1113; --panel:#111; --accent:#f5c542; }
  html,body{height:100%;margin:0;font-family:Arial, sans-serif;background:var(--bg);color:#fff;text-size-adjust:100%;-webkit-text-size-adjust:100%;}
  .screen{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;-webkit-user-select:none;user-select:none;}
  button{cursor:pointer;border:none;border-radius:8px;padding:10px 16px;margin:6px;background:#333;color:#fff;font-size:16px;-webkit-user-select:none;user-select:none;}
  button:hover{background:#555}
  h1{margin:8px}
  /* ‰∏ªËèúÂçï */
  #main-menu{display:flex}
  /* ÂÖ≥Âç°ÈÄâÊã© */
  #level-select .levels{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;max-width:920px}
  .level-btn{width:160px;height:72px;display:flex;align-items:center;justify-content:center;background:#222;border-radius:8px;font-size:18px}
  /* Ê∏∏ÊàèÂÆπÂô® */
  #game-container{display:flex;background:#000;align-items:center;justify-content:center}
  #hud{position:absolute;left:18px;top:18px;z-index:30;display:flex;flex-direction:column;gap:8px}
  #hud button{padding:6px 10px;font-size:14px}
  /* ËÉúÂà©Ê°Ü */
  #winBox{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.96);color:#222;padding:20px 26px;border-radius:10px;display:none;z-index:60;text-align:center;-webkit-user-select:none;user-select:none;}
  #winBox button{margin:6px}
  /* loading overlay */
  #loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:50;color:#fff}
  /* small info */
  .info {opacity:0.85;font-size:13px}
  /* Èü≥‰πêÊéßÂà∂ */
  #music-control{position:absolute;right:18px;top:18px;z-index:30}
  #music-control button{background:rgba(0,0,0,0.7);color:#fff}
</style>
</head>
<body>

<!-- ‰∏ªËèúÂçï -->
<div id="main-menu" class="screen">
  <h1 style="font-size:56px">üç∫ –ü–∏–≤–Ω–æ–π –°–æ–∫–æ–±–∞–Ω</h1>
  <div style="display:flex;flex-direction:column;align-items:center">
    <div style="margin-bottom:14px">
      <button id="startGameBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
      <button id="levelSelectBtn">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</button>
      <button onclick="openSettings()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
    <div class="info">–¶–µ–ª—å: –¢–æ–ª–∫–∞–π—Ç–µ –æ—Ç–∫—Ä—ã–≤–∞—à–∫–∏ (—è—â–∏–∫–∏) –Ω–∞ –ø–∏–≤–æ ‚Üí –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–∏—Ç—å—è ‚Üí –í—ã–ø–µ–π—Ç–µ –≤—Å—ë –ø–∏–≤–æ, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —É—Ä–æ–≤–µ–Ω—å</div>
    <div class="info">–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–æ–ª–∫–∞—Ç—å –ø—É—Å—Ç—ã–µ –±—É—Ç—ã–ª–∫–∏!</div>
  </div>
</div>

<!-- ÂÖ≥Âç°ÈÄâÊã© -->
<div id="level-select" class="screen">
  <h1 style="font-size:44px">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</h1>
  <div class="levels" id="levelsContainer" style="margin:18px"></div>
  <div style="margin-top:16px">
    <button onclick="returnToMenu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
  </div>
</div>

<!-- Ê∏∏ÊàèÁïåÈù¢ -->
<div id="game-container" class="screen">
  <div style="position:relative">
    <canvas id="gameCanvas" width="680" height="680"></canvas>
    <div id="hud" style="">
      <div>–£—Ä–æ–≤–µ–Ω—å <span id="currentLevelLabel">1</span></div>
      <div>–®–∞–≥–∏: <span id="moveCount">0</span></div>
      <div><button onclick="restartLevel()">–°–±—Ä–æ—Å</button><button onclick="openLevelSelect()">–í—ã–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É —É—Ä–æ–≤–Ω—è</button></div>
    </div>
    <div id="music-control">
      <button id="toggleMusic">üîä –ú—É–∑—ã–∫–∞</button>
    </div>
  </div>
</div>

<!-- ËÉúÂà©ÊèêÁ§∫ -->
<div id="winBox">
  <div id="winText" style="font-size:18px;margin-bottom:10px">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</div>
  <div>
    <button id="btnNext">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å</button>
    <button id="btnReplay">–ü–µ—Ä–µ–∏–≥—Ä–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
    <button onclick="openLevelSelect()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —É—Ä–æ–≤–Ω—è</button>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay"><div style="text-align:center"><h2>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤‚Ä¶</h2></div></div>

<script>
/* =========================
   ÈÖçÁΩÆ‰∏éËµÑÊ∫ê
   ========================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE = 60;      // 12 * 60 = 720
const COLS = 12, ROWS = 12;

const imagesToLoad = {
  bg: "./images/bg_room.png",
  floor: "./images/floor.png",
  wall: "./images/wall.png",
  player: "./images/player.png",
  box: "./images/opener.png",
  beer: "./images/beer.png",
  drink: "./images/drink.gif",
  emptyBeer: "./images/empty_beer.png"
};

// Ê∑ªÂä†Èü≥È¢ëËµÑÊ∫ê
const audioToLoad = {
  bgMusic: "./audio/background-music.mp3",
  drinkSound: "./audio/drink-sound.mp3"
};

let imgs = {};
let audio = {};
let loaded = 0, totalImgs = Object.keys(imagesToLoad).length;
let audioLoaded = 0, totalAudio = Object.keys(audioToLoad).length;
let resourcesReady = false;

// Èü≥È¢ëÁä∂ÊÄÅ
let musicEnabled = true; // ÈªòËÆ§ÂêØÁî®Èü≥‰πê
let audioInitialized = false;

// ÂàùÂßãÂåñÈü≥È¢ë
function initAudio() {
  if (audioInitialized) return;
  
  // ËÆæÁΩÆÈü≥È¢ëÂ±ûÊÄß
  if (audio.bgMusic) {
    audio.bgMusic.loop = true;
    audio.bgMusic.volume = 0.3;
  }
  
  if (audio.drinkSound) {
    audio.drinkSound.volume = 0.7;
  }
  
  audioInitialized = true;
  console.log("–ê—É–¥–∏–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
}

// Êí≠ÊîæËÉåÊôØÈü≥‰πê
function playBackgroundMusic() {
  if (!musicEnabled || !audio.bgMusic) return;
  
  // ÈáçÁΩÆÂπ∂Êí≠ÊîæÈü≥‰πê
  audio.bgMusic.currentTime = 0;
  audio.bgMusic.play().catch(e => {
    console.log("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏:", e);
  });
}

// Êí≠ÊîæÂñùÂï§ÈÖíÈü≥Êïà
function playDrinkSound() {
  if (!musicEnabled || !audio.drinkSound) return;
  
  audio.drinkSound.currentTime = 0;
  audio.drinkSound.play().catch(e => {
    console.log("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ –ø–∏—Ç—å—è:", e);
  });
}

// ÂàáÊç¢Èü≥‰πê
function toggleMusic() {
  musicEnabled = !musicEnabled;
  const button = document.getElementById('toggleMusic');
  
  if (musicEnabled) {
    button.innerHTML = "üîä –ú—É–∑—ã–∫–∞";
    playBackgroundMusic();
  } else {
    button.innerHTML = "üîá –ú—É–∑—ã–∫–∞";
    if (audio.bgMusic) {
      audio.bgMusic.pause();
    }
  }
}

// Áî®Êà∑‰∫§‰∫íÂêéÂàùÂßãÂåñÈü≥È¢ë
function initAudioOnUserInteraction() {
  if (!audioInitialized) {
    initAudio();
  }
  playBackgroundMusic();
}

function preload() {
  document.getElementById('loadingOverlay').style.display = 'flex';
  
  // È¢ÑÂä†ËΩΩÂõæÁâá
  for (const k in imagesToLoad) {
    const img = new Image();
    img.src = imagesToLoad[k];
    img.onload = () => {
      loaded++;
      console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${k}`);
      if (loaded === totalImgs && audioLoaded === totalAudio) {
        resourcesReady = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        initAudio();
        console.log("–í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
      }
    };
    img.onerror = () => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", imagesToLoad[k]);
      loaded++;
      if (loaded === totalImgs && audioLoaded === totalAudio) {
        resourcesReady = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        initAudio();
      }
    };
    imgs[k] = img;
  }
  
  // È¢ÑÂä†ËΩΩÈü≥È¢ë
  for (const k in audioToLoad) {
    const sound = new Audio();
    sound.src = audioToLoad[k];
    sound.preload = "auto";
    sound.oncanplaythrough = () => {
      audioLoaded++;
      console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞—É–¥–∏–æ: ${k}`);
      if (loaded === totalImgs && audioLoaded === totalAudio) {
        resourcesReady = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        initAudio();
      }
    };
    sound.onerror = () => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:", audioToLoad[k]);
      audioLoaded++;
      if (loaded === totalImgs && audioLoaded === totalAudio) {
        resourcesReady = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        initAudio();
      }
    };
    audio[k] = sound;
  }
}
preload();

/* =========================
   5 ‰∏™ÈáçÊñ∞ËÆæËÆ°ÁöÑ 12x12 ÂÖ≥Âç°ÔºàÂ≠óÁ¨¶Âú∞ÂõæÔºâ
   ========================= */

const LEVELS = [
`############
############
############
#####B######
#####.######
#####O.OB###
###B.OP#####
######O#####
######B#####
############
############
############`,
/* Level 2 */
`############
############
###P..######
###.OO#######
###.O.###B###
#####.###B###
#####....B###
####...#..####
####...########
############
############
############`,
/* Level 3 - ÈáçÊñ∞ËÆæËÆ°‰∏∫Ê≠£Â∏∏Êé®ÁÆ±Â≠êÂÖ≥Âç° */
`############
############
############
#####....###
###B.O##.###
##BBO.O..P##
##BB.O.O.###
#######..###
############
############
############
############`,
/* Level 4 - ÈáçÊñ∞ËÆæËÆ°‰∏∫Ê≠£Â∏∏Êé®ÁÆ±Â≠êÂÖ≥Âç° */
`############
############
############
#####..#.P##
####...#..##
####O.O.O.##
####.O##..##
####.O.#.###
##BBBBB..###
############
############
############`,
/* Level 5 - ÈáçÊñ∞ËÆæËÆ°‰∏∫Ê≠£Â∏∏Êé®ÁÆ±Â≠êÂÖ≥Âç° */
`############
############
############
#####....###
#####OOO.###
###P.OBB.###
###.OBBB####
######..####
############
############
############
############`
].map(s => s.split('\n').map(r => r.split('')));

/* =========================
   ËøêË°åÊó∂Êï∞ÊçÆÁªìÊûÑ‰∏éÁä∂ÊÄÅ
   ========================= */
let map = [];            // 2D numeric map: 0 floor,1 wall,3 box,4 beer,10 emptyBeer placeholder
let playerX = 0, playerY = 0;
let currentLevel = 0;
let drinking = false;
let targetX = null, targetY = null; // where beer was
let moveCount = 0;
let gameActive = false;

/* =========================
   Â∏ÆÂä©Ôºö‰ªéÂ≠óÁ¨¶Âú∞ÂõæÂä†ËΩΩ map
   ========================= */
function loadLevel(id) {
  currentLevel = id;
  const raw = LEVELS[id-1];
  map = Array.from({length:ROWS}, () => Array(COLS).fill(0));
  targetX = targetY = null;
  moveCount = 0;
  document.getElementById('moveCount').innerText = moveCount;
  document.getElementById('currentLevelLabel').innerText = id;

  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      const ch = raw[y][x];
      if (ch === '#') map[y][x] = 1;
      else if (ch === 'P') { playerX = x; playerY = y; map[y][x] = 0; }
      else if (ch === 'O') map[y][x] = 3;
      else if (ch === 'B') map[y][x] = 4;
      else map[y][x] = 0;
    }
  }
  gameActive = true;
  drinking = false;
  // Ê∏≤ÊüìÈ¶ñÂ∏ß
  drawFrame();
}

/* =========================
   ÁªòÂà∂ÔºöËÉåÊôØ„ÄÅÂú∞Êùø„ÄÅÂ¢ô„ÄÅÁÆ±Â≠ê„ÄÅÂï§ÈÖí„ÄÅÁ©∫Áì∂„ÄÅÁé©ÂÆ∂ÊàñÂñùÈÖíÂä®Áîª
   ========================= */
function drawFrame() {
  // ËÉåÊôØ fill
  ctx.fillStyle = '#222';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // draw background image scaled as cover under tiles
  const bg = imgs.bg;
  if (bg && bg.complete) {
    const scale = Math.max(canvas.width/bg.width, canvas.height/bg.height);
    const w = bg.width * scale, h = bg.height * scale;
    const bx = (canvas.width - w)/2, by = (canvas.height - h)/2;
    ctx.globalAlpha = 0.5;
    ctx.drawImage(bg, bx, by, w, h);
    ctx.globalAlpha = 1;
  }

  // tiles
  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      const px = x * TILE, py = y * TILE;
      // floor
      if (imgs.floor && imgs.floor.complete) ctx.drawImage(imgs.floor, px, py, TILE, TILE);
      else { ctx.fillStyle='#333'; ctx.fillRect(px,py,TILE,TILE); }

      // beer (target) - draw before box so box covers it
      if (map[y][x] === 4) {
        if (imgs.beer && imgs.beer.complete) ctx.drawImage(imgs.beer, px, py, TILE, TILE);
      }
      // empty beer (after drinking) stored as 10
      if (map[y][x] === 10) {
        if (imgs.emptyBeer && imgs.emptyBeer.complete) ctx.drawImage(imgs.emptyBeer, px, py, TILE, TILE);
      }
      // walls
      if (map[y][x] === 1) {
        if (imgs.wall && imgs.wall.complete) ctx.drawImage(imgs.wall, px, py, TILE, TILE);
        else { ctx.fillStyle='#666'; ctx.fillRect(px,py,TILE,TILE); }
      }
      // boxes
      if (map[y][x] === 3) {
        if (imgs.box && imgs.box.complete) ctx.drawImage(imgs.box, px, py, TILE, TILE);
      }
    }
  }

  // player or drinking animation
  const px = playerX * TILE, py = playerY * TILE;
  if (drinking) {
    if (imgs.drink && imgs.drink.complete) ctx.drawImage(imgs.drink, px, py, TILE, TILE);
  } else {
    if (imgs.player && imgs.player.complete) ctx.drawImage(imgs.player, px, py, TILE, TILE);
  }
}

/* =========================
   ËæÖÂä©ÔºöÂú∞ÂõæÂùêÊ†áÊúâÊïà‰∏éÂèØËµ∞Ê£ÄÊµã
   ========================= */
function inBounds(x,y){ return x>=0 && x<COLS && y>=0 && y<ROWS; }
function isWall(x,y) { return !inBounds(x,y) || map[y][x] === 1; }
function isBox(x,y) { return inBounds(x,y) && map[y][x] === 3; }
function isBeer(x,y) { return inBounds(x,y) && map[y][x] === 4; }
function isEmptyBottle(x,y) { return inBounds(x,y) && map[y][x] === 10; }
function isEmpty(x,y) { return inBounds(x,y) && (map[y][x] === 0); }

/* =========================
   ÈîÆÁõò‰∫ã‰ª∂ÔºöÁßªÂä® + Êé®ÁÆ±Â≠êÂà∞Âï§ÈÖíËß¶ÂèëÂñùÈÖí
   ========================= */
document.addEventListener('keydown', (e) => {
  if (!gameActive) return;
  if (drinking) return;
  let dx = 0, dy = 0;
  if (e.key === 'ArrowUp') dy = -1;
  else if (e.key === 'ArrowDown') dy = 1;
  else if (e.key === 'ArrowLeft') dx = -1;
  else if (e.key === 'ArrowRight') dx = 1;
  else return;

  const nx = playerX + dx, ny = playerY + dy;
  if (isWall(nx,ny)) return;

  // push case - ÁÆ±Â≠ê
  if (isBox(nx,ny)) {
    const bx = nx + dx, by = ny + dy;
    if (isWall(bx,by) || isBox(bx,by) || isEmptyBottle(bx,by)) return; // cannot push
    // if pushing into a beer
    if (isBeer(bx,by)) {
      // remove box from its tile
      map[ny][nx] = 0;
      // record target location
      targetX = bx; targetY = by;
      // remove beer visually (we'll set empty after drinking)
      map[by][bx] = 0;
      // move player into box's previous spot
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      // start drink animation
      startDrinkAnimation();
    } else if (isEmpty(bx,by)) {
      // standard push
      map[by][bx] = 3;
      map[ny][nx] = 0;
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
      // after move check win (if no beers left)
      if (checkWin()) showWin();
    }
  } 
  // push case - Á©∫ÈÖíÁì∂
  else if (isEmptyBottle(nx,ny)) {
    const bx = nx + dx, by = ny + dy;
    if (isWall(bx,by) || isBox(bx,by)) return; // cannot push into wall or box
    
    // if pushing into a beer, swap positions
    if (isBeer(bx,by)) {
      // swap empty bottle and beer
      map[by][bx] = 10; // beer position becomes empty bottle
      map[ny][nx] = 4;  // empty bottle position becomes beer
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    } 
    // if pushing into empty space
    else if (isEmpty(bx,by)) {
      // move empty bottle
      map[by][bx] = 10;
      map[ny][nx] = 0;
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    }
  } 
  // ÁßªÂä®Áé©ÂÆ∂Âà∞Á©∫Âú∞ÊùøÊàñÂï§ÈÖí‰ΩçÁΩÆ
  else {
    if (isEmpty(nx,ny) || isBeer(nx,ny)) {
      playerX = nx; playerY = ny;
      moveCount++;
      document.getElementById('moveCount').innerText = moveCount;
      drawFrame();
    }
  }
});

/* =========================
   ÂñùÈÖíÂä®ÁîªÔºöÊí≠Êîæ GIFÔºàdrinks) ‰∏ÄÊÆµÊó∂Èó¥Ôºå‰πãÂêéÂú® target Êîæ empty beer
   ========================= */
function startDrinkAnimation(){
  drinking = true;
  playDrinkSound(); // Êí≠ÊîæÂñùÂï§ÈÖíÈü≥Êïà
  drawFrame();
  // duration: adjust if your drink.gif longer; 900ms is reasonable
  setTimeout(() => {
    drinking = false;
    if (targetX !== null && targetY !== null) {
      map[targetY][targetX] = 10; // empty beer shows
      targetX = targetY = null;
    }
    drawFrame();
    // Ê£ÄÊü•ËÉúÂà©ÔºàÂ¶ÇÊûúÊ≤°Êúâ B Ââ©‰∏ãÔºâ
    if (checkWin()) showWin();
  }, 900);
}

/* =========================
   ËÉúÂà©Ê£ÄÊµãÔºàÂú∞ÂõæÈáåÊ≤°ÊúâÂï§ÈÖí BÔºâ
   ========================= */
function checkWin(){
  for (let y=0;y<ROWS;y++){
    for (let x=0;x<COLS;x++){
      if (map[y][x] === 4) return false;
    }
  }
  return true;
}

/* =========================
   UI: ËèúÂçï / ÂÖ≥Âç° / ÊéßÂà∂
   ========================= */
function hideAllScreens(){
  document.getElementById('main-menu').style.display = 'none';
  document.getElementById('level-select').style.display = 'none';
  document.getElementById('game-container').style.display = 'none';
  document.getElementById('winBox').style.display = 'none';
}
function openMainMenu(){ 
  hideAllScreens(); 
  document.getElementById('main-menu').style.display = 'flex'; 
}
function openLevelSelect(){ 
  hideAllScreens(); 
  document.getElementById('level-select').style.display = 'flex'; 
}
function openSettings(){ 
  // Âú®ËÆæÁΩÆ‰∏≠ÊòæÁ§∫Èü≥‰πêÂºÄÂÖ≥
  alert('–ú—É–∑—ã–∫–∞ ' + (musicEnabled ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞') + '. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤ –∏–≥—Ä–æ–≤–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è.'); 
}
function returnToMenu(){ 
  gameActive = false; 
  openMainMenu(); 
}
function restartLevel(){ 
  loadLevel(currentLevel); 
  drawFrame(); 
}

/* Â°´ÂÖÖÂÖ≥Âç°ÈÄâÊã©ÊåâÈíÆ */
function buildLevelButtons(){
  const container = document.getElementById('levelsContainer');
  container.innerHTML = '';
  for (let i=0;i<LEVELS.length;i++){
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    btn.innerText = `–£—Ä–æ–≤–µ–Ω—å ${i+1}`;
    btn.onclick = () => { startLevel(i+1); };
    container.appendChild(btn);
  }
}

/* ÂºÄÂßãÈÄâÂÆöÂÖ≥Âç°ÔºàÂ∏¶ËµÑÊ∫êÂä†ËΩΩÁ≠âÂæÖÔºâ */
function startLevel(n){
  if (!resourcesReady) {
    document.getElementById('loadingOverlay').style.display = 'flex';
    const t = setInterval(()=>{
      if (resourcesReady) { 
        clearInterval(t); 
        document.getElementById('loadingOverlay').style.display='none'; 
        _startLevel(n); 
      }
    },100);
  } else _startLevel(n);
}
function _startLevel(n){
  hideAllScreens();
  document.getElementById('game-container').style.display = 'flex';
  loadLevel(n);
}

/* ËÉúÂà©ÂºπÊ°Ü */
const winBox = document.getElementById('winBox');
const winText = document.getElementById('winText');
const btnNext = document.getElementById('btnNext');
const btnReplay = document.getElementById('btnReplay');

btnNext.addEventListener('click', ()=> {
  if (currentLevel < LEVELS.length) {
    _startLevel(currentLevel+1);
    winBox.style.display = 'none';
  } else {
    openLevelSelect();
    winBox.style.display = 'none';
  }
});
btnReplay.addEventListener('click', ()=> {
  _startLevel(currentLevel);
  winBox.style.display = 'none';
});

function showWin(){
  winText.innerText = `–£—Ä–æ–≤–µ–Ω—å ${currentLevel} –ø—Ä–æ–π–¥–µ–Ω!`;
  btnNext.style.display = (currentLevel < LEVELS.length) ? 'inline-block' : 'none';
  winBox.style.display = 'block';
}

/* È°µÈù¢ÂàùÂßãÂåñ */
window.onload = () => {
  buildLevelButtons();
  openMainMenu();
  
  // Ê∑ªÂä†Èü≥‰πêÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
  document.getElementById('toggleMusic').addEventListener('click', toggleMusic);
  
  // ‰∏∫‰∏ªËèúÂçïÊåâÈíÆÊ∑ªÂä†Èü≥È¢ëÂàùÂßãÂåñ
  document.getElementById('startGameBtn').addEventListener('click', function() {
    initAudioOnUserInteraction();
    openLevelSelect();
  });
  
  document.getElementById('levelSelectBtn').addEventListener('click', function() {
    initAudioOnUserInteraction();
    openLevelSelect();
  });
  
  // draw initial blank canvas
  ctx.fillStyle = '#111';
  ctx.fillRect(0,0,canvas.width,canvas.height);
};

</script>
</body>
</html>